{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\n\nvar _UNIFORM_SETTERS;\n\nimport { log } from '@luma.gl/gltools';\nimport Framebuffer from './framebuffer';\nimport Renderbuffer from './renderbuffer';\nimport Texture from './texture';\nimport { assert } from '../utils';\nvar UNIFORM_SETTERS = (_UNIFORM_SETTERS = {}, _defineProperty(_UNIFORM_SETTERS, 5126, getArraySetter.bind(null, 'uniform1fv', toFloatArray, 1, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35664, getArraySetter.bind(null, 'uniform2fv', toFloatArray, 2, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35665, getArraySetter.bind(null, 'uniform3fv', toFloatArray, 3, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35666, getArraySetter.bind(null, 'uniform4fv', toFloatArray, 4, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 5124, getArraySetter.bind(null, 'uniform1iv', toIntArray, 1, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35667, getArraySetter.bind(null, 'uniform2iv', toIntArray, 2, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35668, getArraySetter.bind(null, 'uniform3iv', toIntArray, 3, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35669, getArraySetter.bind(null, 'uniform4iv', toIntArray, 4, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35670, getArraySetter.bind(null, 'uniform1iv', toIntArray, 1, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35671, getArraySetter.bind(null, 'uniform2iv', toIntArray, 2, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35672, getArraySetter.bind(null, 'uniform3iv', toIntArray, 3, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35673, getArraySetter.bind(null, 'uniform4iv', toIntArray, 4, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35674, getArraySetter.bind(null, 'uniformMatrix2fv', toFloatArray, 4, setMatrixUniform)), _defineProperty(_UNIFORM_SETTERS, 35675, getArraySetter.bind(null, 'uniformMatrix3fv', toFloatArray, 9, setMatrixUniform)), _defineProperty(_UNIFORM_SETTERS, 35676, getArraySetter.bind(null, 'uniformMatrix4fv', toFloatArray, 16, setMatrixUniform)), _defineProperty(_UNIFORM_SETTERS, 35678, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 35680, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 5125, getArraySetter.bind(null, 'uniform1uiv', toUIntArray, 1, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 36294, getArraySetter.bind(null, 'uniform2uiv', toUIntArray, 2, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 36295, getArraySetter.bind(null, 'uniform3uiv', toUIntArray, 3, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 36296, getArraySetter.bind(null, 'uniform4uiv', toUIntArray, 4, setVectorUniform)), _defineProperty(_UNIFORM_SETTERS, 35685, getArraySetter.bind(null, 'uniformMatrix2x3fv', toFloatArray, 6, setMatrixUniform)), _defineProperty(_UNIFORM_SETTERS, 35686, getArraySetter.bind(null, 'uniformMatrix2x4fv', toFloatArray, 8, setMatrixUniform)), _defineProperty(_UNIFORM_SETTERS, 35687, getArraySetter.bind(null, 'uniformMatrix3x2fv', toFloatArray, 6, setMatrixUniform)), _defineProperty(_UNIFORM_SETTERS, 35688, getArraySetter.bind(null, 'uniformMatrix3x4fv', toFloatArray, 12, setMatrixUniform)), _defineProperty(_UNIFORM_SETTERS, 35689, getArraySetter.bind(null, 'uniformMatrix4x2fv', toFloatArray, 8, setMatrixUniform)), _defineProperty(_UNIFORM_SETTERS, 35690, getArraySetter.bind(null, 'uniformMatrix4x3fv', toFloatArray, 12, setMatrixUniform)), _defineProperty(_UNIFORM_SETTERS, 35679, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 35682, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36289, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36292, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36293, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36298, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36299, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36300, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36303, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36306, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36307, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36308, getSamplerSetter), _defineProperty(_UNIFORM_SETTERS, 36311, getSamplerSetter), _UNIFORM_SETTERS);\nvar FLOAT_ARRAY = {};\nvar INT_ARRAY = {};\nvar UINT_ARRAY = {};\nvar array1 = [0];\n\nfunction toTypedArray(value, uniformLength, Type, cache) {\n  if (uniformLength === 1 && typeof value === 'boolean') {\n    value = value ? 1 : 0;\n  }\n\n  if (Number.isFinite(value)) {\n    array1[0] = value;\n    value = array1;\n  }\n\n  var length = value.length;\n\n  if (length % uniformLength) {\n    log.warn(\"Uniform size should be multiples of \".concat(uniformLength), value)();\n  }\n\n  if (value instanceof Type) {\n    return value;\n  }\n\n  var result = cache[length];\n\n  if (!result) {\n    result = new Type(length);\n    cache[length] = result;\n  }\n\n  for (var i = 0; i < length; i++) {\n    result[i] = value[i];\n  }\n\n  return result;\n}\n\nfunction toFloatArray(value, uniformLength) {\n  return toTypedArray(value, uniformLength, Float32Array, FLOAT_ARRAY);\n}\n\nfunction toIntArray(value, uniformLength) {\n  return toTypedArray(value, uniformLength, Int32Array, INT_ARRAY);\n}\n\nfunction toUIntArray(value, uniformLength) {\n  return toTypedArray(value, uniformLength, Uint32Array, UINT_ARRAY);\n}\n\nexport function parseUniformName(name) {\n  if (name[name.length - 1] !== ']') {\n    return {\n      name: name,\n      length: 1,\n      isArray: false\n    };\n  }\n\n  var UNIFORM_NAME_REGEXP = /([^[]*)(\\[[0-9]+\\])?/;\n  var matches = name.match(UNIFORM_NAME_REGEXP);\n\n  if (!matches || matches.length < 2) {\n    throw new Error(\"Failed to parse GLSL uniform name \".concat(name));\n  }\n\n  return {\n    name: matches[1],\n    length: matches[2] || 1,\n    isArray: Boolean(matches[2])\n  };\n}\nexport function getUniformSetter(gl, location, info) {\n  var setter = UNIFORM_SETTERS[info.type];\n\n  if (!setter) {\n    throw new Error(\"Unknown GLSL uniform type \".concat(info.type));\n  }\n\n  return setter().bind(null, gl, location);\n}\nexport function checkUniformValues(uniforms, source, uniformMap) {\n  for (var uniformName in uniforms) {\n    var value = uniforms[uniformName];\n    var shouldCheck = !uniformMap || Boolean(uniformMap[uniformName]);\n\n    if (shouldCheck && !checkUniformValue(value)) {\n      source = source ? \"\".concat(source, \" \") : '';\n      console.error(\"\".concat(source, \" Bad uniform \").concat(uniformName), value);\n      throw new Error(\"\".concat(source, \" Bad uniform \").concat(uniformName));\n    }\n  }\n\n  return true;\n}\n\nfunction checkUniformValue(value) {\n  if (Array.isArray(value) || ArrayBuffer.isView(value)) {\n    return checkUniformArray(value);\n  }\n\n  if (isFinite(value)) {\n    return true;\n  } else if (value === true || value === false) {\n    return true;\n  } else if (value instanceof Texture) {\n    return true;\n  } else if (value instanceof Renderbuffer) {\n    return true;\n  } else if (value instanceof Framebuffer) {\n    return Boolean(value.texture);\n  }\n\n  return false;\n}\n\nfunction checkUniformArray(value) {\n  if (value.length === 0) {\n    return false;\n  }\n\n  var checkLength = Math.min(value.length, 16);\n\n  for (var i = 0; i < checkLength; ++i) {\n    if (!Number.isFinite(value[i])) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\nexport function copyUniform(uniforms, key, value) {\n  if (Array.isArray(value) || ArrayBuffer.isView(value)) {\n    if (uniforms[key]) {\n      var dest = uniforms[key];\n\n      for (var i = 0, len = value.length; i < len; ++i) {\n        dest[i] = value[i];\n      }\n    } else {\n      uniforms[key] = value.slice();\n    }\n  } else {\n    uniforms[key] = value;\n  }\n}\n\nfunction getSamplerSetter() {\n  var cache = null;\n  return function (gl, location, value) {\n    var update = cache !== value;\n\n    if (update) {\n      gl.uniform1i(location, value);\n      cache = value;\n    }\n\n    return update;\n  };\n}\n\nfunction getArraySetter(functionName, toArray, size, uniformSetter) {\n  var cache = null;\n  var cacheLength = null;\n  return function (gl, location, value) {\n    var arrayValue = toArray(value, size);\n    var length = arrayValue.length;\n    var update = false;\n\n    if (cache === null) {\n      cache = new Float32Array(length);\n      cacheLength = length;\n      update = true;\n    } else {\n      assert(cacheLength === length, 'Uniform length cannot change.');\n\n      for (var i = 0; i < length; ++i) {\n        if (arrayValue[i] !== cache[i]) {\n          update = true;\n          break;\n        }\n      }\n    }\n\n    if (update) {\n      uniformSetter(gl, functionName, location, arrayValue);\n      cache.set(arrayValue);\n    }\n\n    return update;\n  };\n}\n\nfunction setVectorUniform(gl, functionName, location, value) {\n  gl[functionName](location, value);\n}\n\nfunction setMatrixUniform(gl, functionName, location, value) {\n  gl[functionName](location, false, value);\n}","map":{"version":3,"sources":["../../../src/classes/uniforms.js"],"names":["UNIFORM_SETTERS","getArraySetter","FLOAT_ARRAY","INT_ARRAY","UINT_ARRAY","array1","uniformLength","value","Number","length","log","result","cache","i","toTypedArray","name","isArray","UNIFORM_NAME_REGEXP","matches","Boolean","setter","info","uniforms","shouldCheck","uniformMap","checkUniformValue","source","console","Array","ArrayBuffer","checkUniformArray","isFinite","checkLength","Math","dest","len","update","gl","cacheLength","arrayValue","toArray","assert","uniformSetter"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants';\nimport {log} from '@luma.gl/gltools';\nimport Framebuffer from './framebuffer';\nimport Renderbuffer from './renderbuffer';\nimport Texture from './texture';\nimport {assert} from '../utils';\n\nconst UNIFORM_SETTERS = {\n  // WEBGL1\n\n  /* eslint-disable max-len */\n  [GL.FLOAT]: getArraySetter.bind(null, 'uniform1fv', toFloatArray, 1, setVectorUniform),\n  [GL.FLOAT_VEC2]: getArraySetter.bind(null, 'uniform2fv', toFloatArray, 2, setVectorUniform),\n  [GL.FLOAT_VEC3]: getArraySetter.bind(null, 'uniform3fv', toFloatArray, 3, setVectorUniform),\n  [GL.FLOAT_VEC4]: getArraySetter.bind(null, 'uniform4fv', toFloatArray, 4, setVectorUniform),\n\n  [GL.INT]: getArraySetter.bind(null, 'uniform1iv', toIntArray, 1, setVectorUniform),\n  [GL.INT_VEC2]: getArraySetter.bind(null, 'uniform2iv', toIntArray, 2, setVectorUniform),\n  [GL.INT_VEC3]: getArraySetter.bind(null, 'uniform3iv', toIntArray, 3, setVectorUniform),\n  [GL.INT_VEC4]: getArraySetter.bind(null, 'uniform4iv', toIntArray, 4, setVectorUniform),\n\n  [GL.BOOL]: getArraySetter.bind(null, 'uniform1iv', toIntArray, 1, setVectorUniform),\n  [GL.BOOL_VEC2]: getArraySetter.bind(null, 'uniform2iv', toIntArray, 2, setVectorUniform),\n  [GL.BOOL_VEC3]: getArraySetter.bind(null, 'uniform3iv', toIntArray, 3, setVectorUniform),\n  [GL.BOOL_VEC4]: getArraySetter.bind(null, 'uniform4iv', toIntArray, 4, setVectorUniform),\n\n  // uniformMatrix(false): don't transpose the matrix\n  [GL.FLOAT_MAT2]: getArraySetter.bind(null, 'uniformMatrix2fv', toFloatArray, 4, setMatrixUniform),\n  [GL.FLOAT_MAT3]: getArraySetter.bind(null, 'uniformMatrix3fv', toFloatArray, 9, setMatrixUniform),\n  [GL.FLOAT_MAT4]: getArraySetter.bind(\n    null,\n    'uniformMatrix4fv',\n    toFloatArray,\n    16,\n    setMatrixUniform\n  ),\n\n  [GL.SAMPLER_2D]: getSamplerSetter,\n  [GL.SAMPLER_CUBE]: getSamplerSetter,\n\n  // WEBGL2 - unsigned integers, irregular matrices, additional texture samplers\n\n  [GL.UNSIGNED_INT]: getArraySetter.bind(null, 'uniform1uiv', toUIntArray, 1, setVectorUniform),\n  [GL.UNSIGNED_INT_VEC2]: getArraySetter.bind(\n    null,\n    'uniform2uiv',\n    toUIntArray,\n    2,\n    setVectorUniform\n  ),\n  [GL.UNSIGNED_INT_VEC3]: getArraySetter.bind(\n    null,\n    'uniform3uiv',\n    toUIntArray,\n    3,\n    setVectorUniform\n  ),\n  [GL.UNSIGNED_INT_VEC4]: getArraySetter.bind(\n    null,\n    'uniform4uiv',\n    toUIntArray,\n    4,\n    setVectorUniform\n  ),\n\n  // uniformMatrix(false): don't transpose the matrix\n  [GL.FLOAT_MAT2x3]: getArraySetter.bind(\n    null,\n    'uniformMatrix2x3fv',\n    toFloatArray,\n    6,\n    setMatrixUniform\n  ),\n  [GL.FLOAT_MAT2x4]: getArraySetter.bind(\n    null,\n    'uniformMatrix2x4fv',\n    toFloatArray,\n    8,\n    setMatrixUniform\n  ),\n  [GL.FLOAT_MAT3x2]: getArraySetter.bind(\n    null,\n    'uniformMatrix3x2fv',\n    toFloatArray,\n    6,\n    setMatrixUniform\n  ),\n  [GL.FLOAT_MAT3x4]: getArraySetter.bind(\n    null,\n    'uniformMatrix3x4fv',\n    toFloatArray,\n    12,\n    setMatrixUniform\n  ),\n  [GL.FLOAT_MAT4x2]: getArraySetter.bind(\n    null,\n    'uniformMatrix4x2fv',\n    toFloatArray,\n    8,\n    setMatrixUniform\n  ),\n  [GL.FLOAT_MAT4x3]: getArraySetter.bind(\n    null,\n    'uniformMatrix4x3fv',\n    toFloatArray,\n    12,\n    setMatrixUniform\n  ),\n\n  [GL.SAMPLER_3D]: getSamplerSetter,\n  [GL.SAMPLER_2D_SHADOW]: getSamplerSetter,\n  [GL.SAMPLER_2D_ARRAY]: getSamplerSetter,\n  [GL.SAMPLER_2D_ARRAY_SHADOW]: getSamplerSetter,\n  [GL.SAMPLER_CUBE_SHADOW]: getSamplerSetter,\n  [GL.INT_SAMPLER_2D]: getSamplerSetter,\n  [GL.INT_SAMPLER_3D]: getSamplerSetter,\n  [GL.INT_SAMPLER_CUBE]: getSamplerSetter,\n  [GL.INT_SAMPLER_2D_ARRAY]: getSamplerSetter,\n  [GL.UNSIGNED_INT_SAMPLER_2D]: getSamplerSetter,\n  [GL.UNSIGNED_INT_SAMPLER_3D]: getSamplerSetter,\n  [GL.UNSIGNED_INT_SAMPLER_CUBE]: getSamplerSetter,\n  [GL.UNSIGNED_INT_SAMPLER_2D_ARRAY]: getSamplerSetter\n  /* eslint-enable max-len */\n};\n\n// Pre-allocated typed arrays for temporary conversion\nconst FLOAT_ARRAY = {};\nconst INT_ARRAY = {};\nconst UINT_ARRAY = {};\n\nconst array1 = [0];\n\n// Functions to ensure the type of uniform values\n// This is done because uniform*v functions\n// are extremely slow when consuming JS arrays directly.\nfunction toTypedArray(value, uniformLength, Type, cache) {\n  // convert boolean uniforms to Number\n  if (uniformLength === 1 && typeof value === 'boolean') {\n    value = value ? 1 : 0;\n  }\n  if (Number.isFinite(value)) {\n    array1[0] = value;\n    value = array1;\n  }\n  const length = value.length;\n  if (length % uniformLength) {\n    log.warn(`Uniform size should be multiples of ${uniformLength}`, value)();\n  }\n\n  if (value instanceof Type) {\n    return value;\n  }\n  let result = cache[length];\n  if (!result) {\n    result = new Type(length);\n    cache[length] = result;\n  }\n  for (let i = 0; i < length; i++) {\n    result[i] = value[i];\n  }\n  return result;\n}\n\nfunction toFloatArray(value, uniformLength) {\n  return toTypedArray(value, uniformLength, Float32Array, FLOAT_ARRAY);\n}\n\nfunction toIntArray(value, uniformLength) {\n  return toTypedArray(value, uniformLength, Int32Array, INT_ARRAY);\n}\n\nfunction toUIntArray(value, uniformLength) {\n  return toTypedArray(value, uniformLength, Uint32Array, UINT_ARRAY);\n}\n\nexport function parseUniformName(name) {\n  // Shortcut to avoid redundant or bad matches\n  if (name[name.length - 1] !== ']') {\n    return {\n      name,\n      length: 1,\n      isArray: false\n    };\n  }\n\n  // if array name then clean the array brackets\n  const UNIFORM_NAME_REGEXP = /([^[]*)(\\[[0-9]+\\])?/;\n  const matches = name.match(UNIFORM_NAME_REGEXP);\n  if (!matches || matches.length < 2) {\n    throw new Error(`Failed to parse GLSL uniform name ${name}`);\n  }\n\n  return {\n    name: matches[1],\n    length: matches[2] || 1,\n    isArray: Boolean(matches[2])\n  };\n}\n\n// Returns a Magic Uniform Setter\n/* eslint-disable complexity */\nexport function getUniformSetter(gl, location, info) {\n  const setter = UNIFORM_SETTERS[info.type];\n  if (!setter) {\n    throw new Error(`Unknown GLSL uniform type ${info.type}`);\n  }\n\n  // NOTE(Tarek): This construction is the ensure\n  // separate caches for all setters.\n  return setter().bind(null, gl, location);\n}\n\n// Basic checks of uniform values (with or without knowledge of program)\n// To facilitate early detection of e.g. undefined values in JavaScript\nexport function checkUniformValues(uniforms, source, uniformMap) {\n  for (const uniformName in uniforms) {\n    const value = uniforms[uniformName];\n    const shouldCheck = !uniformMap || Boolean(uniformMap[uniformName]);\n    if (shouldCheck && !checkUniformValue(value)) {\n      // Add space to source\n      source = source ? `${source} ` : '';\n      // Value could be unprintable so write the object on console\n      console.error(`${source} Bad uniform ${uniformName}`, value); // eslint-disable-line\n      /* eslint-enable no-console */\n      throw new Error(`${source} Bad uniform ${uniformName}`);\n    }\n  }\n  return true;\n}\n\n// TODO use type information during validation\nfunction checkUniformValue(value) {\n  if (Array.isArray(value) || ArrayBuffer.isView(value)) {\n    return checkUniformArray(value);\n  }\n\n  // Check if single value is a number\n  if (isFinite(value)) {\n    return true;\n  } else if (value === true || value === false) {\n    return true;\n  } else if (value instanceof Texture) {\n    return true;\n  } else if (value instanceof Renderbuffer) {\n    return true;\n  } else if (value instanceof Framebuffer) {\n    return Boolean(value.texture);\n  }\n  return false;\n}\n\nfunction checkUniformArray(value) {\n  // Check that every element in array is a number, and at least 1 element\n  if (value.length === 0) {\n    return false;\n  }\n\n  const checkLength = Math.min(value.length, 16);\n\n  for (let i = 0; i < checkLength; ++i) {\n    if (!Number.isFinite(value[i])) {\n      return false;\n    }\n  }\n\n  return true;\n}\n\n/**\n * Creates a copy of the uniform\n */\nexport function copyUniform(uniforms, key, value) {\n  if (Array.isArray(value) || ArrayBuffer.isView(value)) {\n    if (uniforms[key]) {\n      const dest = uniforms[key];\n      for (let i = 0, len = value.length; i < len; ++i) {\n        dest[i] = value[i];\n      }\n    } else {\n      uniforms[key] = value.slice();\n    }\n  } else {\n    uniforms[key] = value;\n  }\n}\n// NOTE(Tarek): Setters maintain a cache\n// of the previously set value, and\n// avoid resetting it if it's the same.\nfunction getSamplerSetter() {\n  let cache = null;\n  return (gl, location, value) => {\n    const update = cache !== value;\n    if (update) {\n      gl.uniform1i(location, value);\n      cache = value;\n    }\n\n    return update;\n  };\n}\n\nfunction getArraySetter(functionName, toArray, size, uniformSetter) {\n  let cache = null;\n  let cacheLength = null;\n  return (gl, location, value) => {\n    const arrayValue = toArray(value, size);\n    const length = arrayValue.length;\n    let update = false;\n    if (cache === null) {\n      cache = new Float32Array(length);\n      cacheLength = length;\n      update = true;\n    } else {\n      assert(cacheLength === length, 'Uniform length cannot change.');\n      for (let i = 0; i < length; ++i) {\n        if (arrayValue[i] !== cache[i]) {\n          update = true;\n          break;\n        }\n      }\n    }\n    if (update) {\n      uniformSetter(gl, functionName, location, arrayValue);\n      cache.set(arrayValue);\n    }\n\n    return update;\n  };\n}\n\nfunction setVectorUniform(gl, functionName, location, value) {\n  gl[functionName](location, value);\n}\n\nfunction setMatrixUniform(gl, functionName, location, value) {\n  gl[functionName](location, false, value);\n}\n"]},"metadata":{},"sourceType":"module"}