{"ast":null,"code":"import _typeof from \"@babel/runtime/helpers/esm/typeof\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport { isWebGL, createGLContext, instrumentGLContext, resizeGLContext, resetParameters } from '@luma.gl/gltools';\nimport { requestAnimationFrame, cancelAnimationFrame, Query, lumaStats, Framebuffer, log, assert } from '@luma.gl/webgl';\nimport { isBrowser } from 'probe.gl/env';\nvar isPage = isBrowser() && typeof document !== 'undefined';\nvar statIdCounter = 0;\n\nvar AnimationLoop = function () {\n  function AnimationLoop() {\n    var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    _classCallCheck(this, AnimationLoop);\n\n    var _props$onCreateContex = props.onCreateContext,\n        onCreateContext = _props$onCreateContex === void 0 ? function (opts) {\n      return createGLContext(opts);\n    } : _props$onCreateContex,\n        _props$onAddHTML = props.onAddHTML,\n        onAddHTML = _props$onAddHTML === void 0 ? null : _props$onAddHTML,\n        _props$onInitialize = props.onInitialize,\n        onInitialize = _props$onInitialize === void 0 ? function () {} : _props$onInitialize,\n        _props$onRender = props.onRender,\n        onRender = _props$onRender === void 0 ? function () {} : _props$onRender,\n        _props$onFinalize = props.onFinalize,\n        onFinalize = _props$onFinalize === void 0 ? function () {} : _props$onFinalize,\n        _props$gl = props.gl,\n        gl = _props$gl === void 0 ? null : _props$gl,\n        _props$glOptions = props.glOptions,\n        glOptions = _props$glOptions === void 0 ? {} : _props$glOptions,\n        _props$debug = props.debug,\n        debug = _props$debug === void 0 ? false : _props$debug,\n        _props$createFramebuf = props.createFramebuffer,\n        createFramebuffer = _props$createFramebuf === void 0 ? false : _props$createFramebuf,\n        _props$autoResizeView = props.autoResizeViewport,\n        autoResizeViewport = _props$autoResizeView === void 0 ? true : _props$autoResizeView,\n        _props$autoResizeDraw = props.autoResizeDrawingBuffer,\n        autoResizeDrawingBuffer = _props$autoResizeDraw === void 0 ? true : _props$autoResizeDraw,\n        _props$stats = props.stats,\n        stats = _props$stats === void 0 ? lumaStats.get(\"animation-loop-\".concat(statIdCounter++)) : _props$stats;\n    var _props$useDevicePixel = props.useDevicePixels,\n        useDevicePixels = _props$useDevicePixel === void 0 ? true : _props$useDevicePixel;\n\n    if ('useDevicePixelRatio' in props) {\n      log.deprecated('useDevicePixelRatio', 'useDevicePixels')();\n      useDevicePixels = props.useDevicePixelRatio;\n    }\n\n    this.props = {\n      onCreateContext: onCreateContext,\n      onAddHTML: onAddHTML,\n      onInitialize: onInitialize,\n      onRender: onRender,\n      onFinalize: onFinalize,\n      gl: gl,\n      glOptions: glOptions,\n      debug: debug,\n      createFramebuffer: createFramebuffer\n    };\n    this.gl = gl;\n    this.needsRedraw = null;\n    this.timeline = null;\n    this.stats = stats;\n    this.cpuTime = this.stats.get('CPU Time');\n    this.gpuTime = this.stats.get('GPU Time');\n    this.frameRate = this.stats.get('Frame Rate');\n    this._initialized = false;\n    this._running = false;\n    this._animationFrameId = null;\n    this._nextFramePromise = null;\n    this._resolveNextFrame = null;\n    this._cpuStartTime = 0;\n    this.setProps({\n      autoResizeViewport: autoResizeViewport,\n      autoResizeDrawingBuffer: autoResizeDrawingBuffer,\n      useDevicePixels: useDevicePixels\n    });\n    this.start = this.start.bind(this);\n    this.stop = this.stop.bind(this);\n    this._pageLoadPromise = null;\n    this._onMousemove = this._onMousemove.bind(this);\n    this._onMouseleave = this._onMouseleave.bind(this);\n  }\n\n  _createClass(AnimationLoop, [{\n    key: \"delete\",\n    value: function _delete() {\n      this.stop();\n\n      this._setDisplay(null);\n    }\n  }, {\n    key: \"setNeedsRedraw\",\n    value: function setNeedsRedraw(reason) {\n      assert(typeof reason === 'string');\n      this.needsRedraw = this.needsRedraw || reason;\n      return this;\n    }\n  }, {\n    key: \"setProps\",\n    value: function setProps(props) {\n      if ('autoResizeViewport' in props) {\n        this.autoResizeViewport = props.autoResizeViewport;\n      }\n\n      if ('autoResizeDrawingBuffer' in props) {\n        this.autoResizeDrawingBuffer = props.autoResizeDrawingBuffer;\n      }\n\n      if ('useDevicePixels' in props) {\n        this.useDevicePixels = props.useDevicePixels;\n      }\n\n      return this;\n    }\n  }, {\n    key: \"start\",\n    value: function start() {\n      var _this = this;\n\n      var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n      if (this._running) {\n        return this;\n      }\n\n      this._running = true;\n\n      this._getPageLoadPromise().then(function () {\n        if (!_this._running || _this._initialized) {\n          return null;\n        }\n\n        _this._createWebGLContext(opts);\n\n        _this._createFramebuffer();\n\n        _this._startEventHandling();\n\n        _this._initializeCallbackData();\n\n        _this._updateCallbackData();\n\n        _this._resizeCanvasDrawingBuffer();\n\n        _this._resizeViewport();\n\n        _this._gpuTimeQuery = Query.isSupported(_this.gl, ['timers']) ? new Query(_this.gl) : null;\n        _this._initialized = true;\n        return _this.onInitialize(_this.animationProps);\n      }).then(function (appContext) {\n        if (_this._running) {\n          _this._addCallbackData(appContext || {});\n\n          if (appContext !== false) {\n            _this._startLoop();\n          }\n        }\n      });\n\n      return this;\n    }\n  }, {\n    key: \"redraw\",\n    value: function redraw() {\n      this._beginTimers();\n\n      this._setupFrame();\n\n      this._updateCallbackData();\n\n      this._renderFrame(this.animationProps);\n\n      this._clearNeedsRedraw();\n\n      if (this.offScreen && this.gl.commit) {\n        this.gl.commit();\n      }\n\n      if (this._resolveNextFrame) {\n        this._resolveNextFrame(this);\n\n        this._nextFramePromise = null;\n        this._resolveNextFrame = null;\n      }\n\n      this._endTimers();\n\n      return this;\n    }\n  }, {\n    key: \"stop\",\n    value: function stop() {\n      if (this._running) {\n        this._finalizeCallbackData();\n\n        cancelAnimationFrame(this._animationFrameId);\n        this._nextFramePromise = null;\n        this._resolveNextFrame = null;\n        this._animationFrameId = null;\n        this._running = false;\n      }\n\n      return this;\n    }\n  }, {\n    key: \"attachTimeline\",\n    value: function attachTimeline(timeline) {\n      this.timeline = timeline;\n      return this.timeline;\n    }\n  }, {\n    key: \"detachTimeline\",\n    value: function detachTimeline() {\n      this.timeline = null;\n    }\n  }, {\n    key: \"waitForRender\",\n    value: function waitForRender() {\n      var _this2 = this;\n\n      this.setNeedsRedraw('waitForRender');\n\n      if (!this._nextFramePromise) {\n        this._nextFramePromise = new Promise(function (resolve) {\n          _this2._resolveNextFrame = resolve;\n        });\n      }\n\n      return this._nextFramePromise;\n    }\n  }, {\n    key: \"toDataURL\",\n    value: function () {\n      var _toDataURL = _asyncToGenerator(_regeneratorRuntime.mark(function _callee() {\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                this.setNeedsRedraw('toDataURL');\n                _context.next = 3;\n                return this.waitForRender();\n\n              case 3:\n                return _context.abrupt(\"return\", this.gl.canvas.toDataURL());\n\n              case 4:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function toDataURL() {\n        return _toDataURL.apply(this, arguments);\n      }\n\n      return toDataURL;\n    }()\n  }, {\n    key: \"onCreateContext\",\n    value: function onCreateContext() {\n      var _this$props;\n\n      return (_this$props = this.props).onCreateContext.apply(_this$props, arguments);\n    }\n  }, {\n    key: \"onInitialize\",\n    value: function onInitialize() {\n      var _this$props2;\n\n      return (_this$props2 = this.props).onInitialize.apply(_this$props2, arguments);\n    }\n  }, {\n    key: \"onRender\",\n    value: function onRender() {\n      var _this$props3;\n\n      return (_this$props3 = this.props).onRender.apply(_this$props3, arguments);\n    }\n  }, {\n    key: \"onFinalize\",\n    value: function onFinalize() {\n      var _this$props4;\n\n      return (_this$props4 = this.props).onFinalize.apply(_this$props4, arguments);\n    }\n  }, {\n    key: \"getHTMLControlValue\",\n    value: function getHTMLControlValue(id) {\n      var defaultValue = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1;\n      var element = document.getElementById(id);\n      return element ? Number(element.value) : defaultValue;\n    }\n  }, {\n    key: \"setViewParameters\",\n    value: function setViewParameters() {\n      log.removed('AnimationLoop.setViewParameters', 'AnimationLoop.setProps')();\n      return this;\n    }\n  }, {\n    key: \"_startLoop\",\n    value: function _startLoop() {\n      var _this3 = this;\n\n      var renderFrame = function renderFrame() {\n        if (!_this3._running) {\n          return;\n        }\n\n        _this3.redraw();\n\n        _this3._animationFrameId = _this3._requestAnimationFrame(renderFrame);\n      };\n\n      cancelAnimationFrame(this._animationFrameId);\n      this._animationFrameId = this._requestAnimationFrame(renderFrame);\n    }\n  }, {\n    key: \"_getPageLoadPromise\",\n    value: function _getPageLoadPromise() {\n      if (!this._pageLoadPromise) {\n        this._pageLoadPromise = isPage ? new Promise(function (resolve, reject) {\n          if (isPage && document.readyState === 'complete') {\n            resolve(document);\n            return;\n          }\n\n          window.addEventListener('load', function () {\n            resolve(document);\n          });\n        }) : Promise.resolve({});\n      }\n\n      return this._pageLoadPromise;\n    }\n  }, {\n    key: \"_setDisplay\",\n    value: function _setDisplay(display) {\n      if (this.display) {\n        this.display[\"delete\"]();\n        this.display.animationLoop = null;\n      }\n\n      if (display) {\n        display.animationLoop = this;\n      }\n\n      this.display = display;\n    }\n  }, {\n    key: \"_requestAnimationFrame\",\n    value: function _requestAnimationFrame(renderFrameCallback) {\n      if (this.display && this.display.requestAnimationFrame(renderFrameCallback)) {\n        return;\n      }\n\n      requestAnimationFrame(renderFrameCallback);\n    }\n  }, {\n    key: \"_renderFrame\",\n    value: function _renderFrame() {\n      if (this.display) {\n        var _this$display;\n\n        (_this$display = this.display)._renderFrame.apply(_this$display, arguments);\n\n        return;\n      }\n\n      this.onRender.apply(this, arguments);\n    }\n  }, {\n    key: \"_clearNeedsRedraw\",\n    value: function _clearNeedsRedraw() {\n      this.needsRedraw = null;\n    }\n  }, {\n    key: \"_setupFrame\",\n    value: function _setupFrame() {\n      if (this._onSetupFrame) {\n        this._onSetupFrame(this.animationProps);\n      } else {\n        this._resizeCanvasDrawingBuffer();\n\n        this._resizeViewport();\n\n        this._resizeFramebuffer();\n      }\n    }\n  }, {\n    key: \"_initializeCallbackData\",\n    value: function _initializeCallbackData() {\n      this.animationProps = {\n        gl: this.gl,\n        stop: this.stop,\n        canvas: this.gl.canvas,\n        framebuffer: this.framebuffer,\n        useDevicePixels: this.useDevicePixels,\n        needsRedraw: null,\n        startTime: Date.now(),\n        engineTime: 0,\n        tick: 0,\n        tock: 0,\n        time: 0,\n        _timeline: this.timeline,\n        _loop: this,\n        _animationLoop: this,\n        _mousePosition: null\n      };\n    }\n  }, {\n    key: \"_updateCallbackData\",\n    value: function _updateCallbackData() {\n      var _this$_getSizeAndAspe = this._getSizeAndAspect(),\n          width = _this$_getSizeAndAspe.width,\n          height = _this$_getSizeAndAspe.height,\n          aspect = _this$_getSizeAndAspe.aspect;\n\n      if (width !== this.animationProps.width || height !== this.animationProps.height) {\n        this.setNeedsRedraw('drawing buffer resized');\n      }\n\n      if (aspect !== this.animationProps.aspect) {\n        this.setNeedsRedraw('drawing buffer aspect changed');\n      }\n\n      this.animationProps.width = width;\n      this.animationProps.height = height;\n      this.animationProps.aspect = aspect;\n      this.animationProps.needsRedraw = this.needsRedraw;\n      this.animationProps.engineTime = Date.now() - this.animationProps.startTime;\n\n      if (this.timeline) {\n        this.timeline.update(this.animationProps.engineTime);\n      }\n\n      this.animationProps.tick = Math.floor(this.animationProps.time / 1000 * 60);\n      this.animationProps.tock++;\n      this.animationProps.time = this.timeline ? this.timeline.getTime() : this.animationProps.engineTime;\n      this.animationProps._offScreen = this.offScreen;\n    }\n  }, {\n    key: \"_finalizeCallbackData\",\n    value: function _finalizeCallbackData() {\n      this.onFinalize(this.animationProps);\n    }\n  }, {\n    key: \"_addCallbackData\",\n    value: function _addCallbackData(appContext) {\n      if (_typeof(appContext) === 'object' && appContext !== null) {\n        this.animationProps = Object.assign({}, this.animationProps, appContext);\n      }\n    }\n  }, {\n    key: \"_createWebGLContext\",\n    value: function _createWebGLContext(opts) {\n      this.offScreen = opts.canvas && typeof OffscreenCanvas !== 'undefined' && opts.canvas instanceof OffscreenCanvas;\n      opts = Object.assign({}, opts, this.props.glOptions);\n      this.gl = this.props.gl ? instrumentGLContext(this.props.gl, opts) : this.onCreateContext(opts);\n\n      if (!isWebGL(this.gl)) {\n        throw new Error('AnimationLoop.onCreateContext - illegal context returned');\n      }\n\n      resetParameters(this.gl);\n\n      this._createInfoDiv();\n    }\n  }, {\n    key: \"_createInfoDiv\",\n    value: function _createInfoDiv() {\n      if (this.gl.canvas && this.props.onAddHTML) {\n        var wrapperDiv = document.createElement('div');\n        document.body.appendChild(wrapperDiv);\n        wrapperDiv.style.position = 'relative';\n        var div = document.createElement('div');\n        div.style.position = 'absolute';\n        div.style.left = '10px';\n        div.style.bottom = '10px';\n        div.style.width = '300px';\n        div.style.background = 'white';\n        wrapperDiv.appendChild(this.gl.canvas);\n        wrapperDiv.appendChild(div);\n        var html = this.props.onAddHTML(div);\n\n        if (html) {\n          div.innerHTML = html;\n        }\n      }\n    }\n  }, {\n    key: \"_getSizeAndAspect\",\n    value: function _getSizeAndAspect() {\n      var width = this.gl.drawingBufferWidth;\n      var height = this.gl.drawingBufferHeight;\n      var aspect = 1;\n      var canvas = this.gl.canvas;\n\n      if (canvas && canvas.clientHeight) {\n        aspect = canvas.clientWidth / canvas.clientHeight;\n      } else if (width > 0 && height > 0) {\n        aspect = width / height;\n      }\n\n      return {\n        width: width,\n        height: height,\n        aspect: aspect\n      };\n    }\n  }, {\n    key: \"_resizeViewport\",\n    value: function _resizeViewport() {\n      if (this.autoResizeViewport) {\n        this.gl.viewport(0, 0, this.gl.drawingBufferWidth, this.gl.drawingBufferHeight);\n      }\n    }\n  }, {\n    key: \"_resizeCanvasDrawingBuffer\",\n    value: function _resizeCanvasDrawingBuffer() {\n      if (this.autoResizeDrawingBuffer) {\n        resizeGLContext(this.gl, {\n          useDevicePixels: this.useDevicePixels\n        });\n      }\n    }\n  }, {\n    key: \"_createFramebuffer\",\n    value: function _createFramebuffer() {\n      if (this.props.createFramebuffer) {\n        this.framebuffer = new Framebuffer(this.gl);\n      }\n    }\n  }, {\n    key: \"_resizeFramebuffer\",\n    value: function _resizeFramebuffer() {\n      if (this.framebuffer) {\n        this.framebuffer.resize({\n          width: this.gl.drawingBufferWidth,\n          height: this.gl.drawingBufferHeight\n        });\n      }\n    }\n  }, {\n    key: \"_beginTimers\",\n    value: function _beginTimers() {\n      this.frameRate.timeEnd();\n      this.frameRate.timeStart();\n\n      if (this._gpuTimeQuery && this._gpuTimeQuery.isResultAvailable() && !this._gpuTimeQuery.isTimerDisjoint()) {\n        this.stats.get('GPU Time').addTime(this._gpuTimeQuery.getTimerMilliseconds());\n      }\n\n      if (this._gpuTimeQuery) {\n        this._gpuTimeQuery.beginTimeElapsedQuery();\n      }\n\n      this.cpuTime.timeStart();\n    }\n  }, {\n    key: \"_endTimers\",\n    value: function _endTimers() {\n      this.cpuTime.timeEnd();\n\n      if (this._gpuTimeQuery) {\n        this._gpuTimeQuery.end();\n      }\n    }\n  }, {\n    key: \"_startEventHandling\",\n    value: function _startEventHandling() {\n      var canvas = this.gl.canvas;\n\n      if (canvas) {\n        canvas.addEventListener('mousemove', this._onMousemove);\n        canvas.addEventListener('mouseleave', this._onMouseleave);\n      }\n    }\n  }, {\n    key: \"_onMousemove\",\n    value: function _onMousemove(e) {\n      this.animationProps._mousePosition = [e.offsetX, e.offsetY];\n    }\n  }, {\n    key: \"_onMouseleave\",\n    value: function _onMouseleave(e) {\n      this.animationProps._mousePosition = null;\n    }\n  }]);\n\n  return AnimationLoop;\n}();\n\nexport { AnimationLoop as default };","map":{"version":3,"sources":["../../../src/lib/animation-loop.js"],"names":["isPage","isBrowser","statIdCounter","AnimationLoop","props","onCreateContext","createGLContext","onAddHTML","onInitialize","onRender","onFinalize","gl","glOptions","debug","createFramebuffer","autoResizeViewport","autoResizeDrawingBuffer","stats","lumaStats","useDevicePixels","log","reason","assert","opts","Query","appContext","cancelAnimationFrame","timeline","id","defaultValue","element","document","Number","renderFrame","resolve","window","Promise","display","renderFrameCallback","requestAnimationFrame","stop","canvas","framebuffer","needsRedraw","startTime","Date","engineTime","tick","tock","time","_timeline","_loop","_animationLoop","_mousePosition","width","height","aspect","Math","Object","instrumentGLContext","isWebGL","resetParameters","wrapperDiv","div","html","resizeGLContext","drawingBufferHeight","e"],"mappings":";;;;;AACA,SAAA,OAAA,EAAA,eAAA,EAAA,mBAAA,EAAA,eAAA,EAAA,eAAA,QAAA,kBAAA;AAOA,SAAA,qBAAA,EAAA,oBAAA,EAAA,KAAA,EAAA,SAAA,EAAA,WAAA,EAAA,GAAA,EAAA,MAAA,QAAA,gBAAA;AAUA,SAAA,SAAA,QAAA,cAAA;AAEA,IAAMA,MAAM,GAAGC,SAAS,MAAM,OAAA,QAAA,KAA9B,WAAA;AAEA,IAAIC,aAAa,GAAjB,CAAA;;IAEqBC,a;AAInB,WAAA,aAAA,GAAwB;AAAA,QAAZC,KAAY,GAAA,SAAA,CAAA,MAAA,GAAA,CAAA,IAAA,SAAA,CAAA,CAAA,CAAA,KAAA,SAAA,GAAA,SAAA,CAAA,CAAA,CAAA,GAAJ,EAAI;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,aAAA,CAAA;;AAAA,QAAA,qBAAA,GAkBlBA,KAlBkB,CAAA,eAAA;AAAA,QAEpBC,eAFoB,GAAA,qBAAA,KAAA,KAAA,CAAA,GAEF,UAAA,IAAA,EAAI;AAAA,aAAIC,eAAe,CAAnB,IAAmB,CAAnB;AAFF,KAAA,GAAA,qBAAA;AAAA,QAAA,gBAAA,GAkBlBF,KAlBkB,CAAA,SAAA;AAAA,QAGpBG,SAHoB,GAAA,gBAAA,KAAA,KAAA,CAAA,GAAA,IAAA,GAAA,gBAAA;AAAA,QAAA,mBAAA,GAkBlBH,KAlBkB,CAAA,YAAA;AAAA,QAIpBI,YAJoB,GAAA,mBAAA,KAAA,KAAA,CAAA,GAIL,YAAM,CAJD,CAAA,GAAA,mBAAA;AAAA,QAAA,eAAA,GAkBlBJ,KAlBkB,CAAA,QAAA;AAAA,QAKpBK,QALoB,GAAA,eAAA,KAAA,KAAA,CAAA,GAKT,YAAM,CALG,CAAA,GAAA,eAAA;AAAA,QAAA,iBAAA,GAkBlBL,KAlBkB,CAAA,UAAA;AAAA,QAMpBM,UANoB,GAAA,iBAAA,KAAA,KAAA,CAAA,GAMP,YAAM,CANC,CAAA,GAAA,iBAAA;AAAA,QAAA,SAAA,GAkBlBN,KAlBkB,CAAA,EAAA;AAAA,QAQpBO,EARoB,GAAA,SAAA,KAAA,KAAA,CAAA,GAAA,IAAA,GAAA,SAAA;AAAA,QAAA,gBAAA,GAkBlBP,KAlBkB,CAAA,SAAA;AAAA,QASpBQ,SAToB,GAAA,gBAAA,KAAA,KAAA,CAAA,GAAA,EAAA,GAAA,gBAAA;AAAA,QAAA,YAAA,GAkBlBR,KAlBkB,CAAA,KAAA;AAAA,QAUpBS,KAVoB,GAAA,YAAA,KAAA,KAAA,CAAA,GAAA,KAAA,GAAA,YAAA;AAAA,QAAA,qBAAA,GAkBlBT,KAlBkB,CAAA,iBAAA;AAAA,QAYpBU,iBAZoB,GAAA,qBAAA,KAAA,KAAA,CAAA,GAAA,KAAA,GAAA,qBAAA;AAAA,QAAA,qBAAA,GAkBlBV,KAlBkB,CAAA,kBAAA;AAAA,QAepBW,kBAfoB,GAAA,qBAAA,KAAA,KAAA,CAAA,GAAA,IAAA,GAAA,qBAAA;AAAA,QAAA,qBAAA,GAkBlBX,KAlBkB,CAAA,uBAAA;AAAA,QAgBpBY,uBAhBoB,GAAA,qBAAA,KAAA,KAAA,CAAA,GAAA,IAAA,GAAA,qBAAA;AAAA,QAAA,YAAA,GAkBlBZ,KAlBkB,CAAA,KAAA;AAAA,QAiBpBa,KAjBoB,GAAA,YAAA,KAAA,KAAA,CAAA,GAiBZC,SAAS,CAATA,GAAAA,CAAAA,kBAAAA,MAAAA,CAAgChB,aAjBpB,EAiBZgB,CAAAA,CAjBY,GAAA,YAAA;AAAA,QAAA,qBAAA,GAoBSd,KApBT,CAAA,eAAA;AAAA,QAoBjBe,eApBiB,GAAA,qBAAA,KAAA,KAAA,CAAA,GAAA,IAAA,GAAA,qBAAA;;AAsBtB,QAAI,yBAAJ,KAAA,EAAoC;AAClCC,MAAAA,GAAG,CAAHA,UAAAA,CAAAA,qBAAAA,EAAAA,iBAAAA;AACAD,MAAAA,eAAe,GAAGf,KAAK,CAAvBe,mBAAAA;AACD;;AAED,SAAA,KAAA,GAAa;AACXd,MAAAA,eAAe,EADJ,eAAA;AAEXE,MAAAA,SAAS,EAFE,SAAA;AAGXC,MAAAA,YAAY,EAHD,YAAA;AAIXC,MAAAA,QAAQ,EAJG,QAAA;AAKXC,MAAAA,UAAU,EALC,UAAA;AAOXC,MAAAA,EAAE,EAPS,EAAA;AAQXC,MAAAA,SAAS,EARE,SAAA;AASXC,MAAAA,KAAK,EATM,KAAA;AAUXC,MAAAA,iBAAiB,EAAjBA;AAVW,KAAb;AAcA,SAAA,EAAA,GAAA,EAAA;AACA,SAAA,WAAA,GAAA,IAAA;AACA,SAAA,QAAA,GAAA,IAAA;AACA,SAAA,KAAA,GAAA,KAAA;AACA,SAAA,OAAA,GAAe,KAAA,KAAA,CAAA,GAAA,CAAf,UAAe,CAAf;AACA,SAAA,OAAA,GAAe,KAAA,KAAA,CAAA,GAAA,CAAf,UAAe,CAAf;AACA,SAAA,SAAA,GAAiB,KAAA,KAAA,CAAA,GAAA,CAAjB,YAAiB,CAAjB;AAEA,SAAA,YAAA,GAAA,KAAA;AACA,SAAA,QAAA,GAAA,KAAA;AACA,SAAA,iBAAA,GAAA,IAAA;AACA,SAAA,iBAAA,GAAA,IAAA;AACA,SAAA,iBAAA,GAAA,IAAA;AACA,SAAA,aAAA,GAAA,CAAA;AAEA,SAAA,QAAA,CAAc;AACZC,MAAAA,kBAAkB,EADN,kBAAA;AAEZC,MAAAA,uBAAuB,EAFX,uBAAA;AAGZG,MAAAA,eAAe,EAAfA;AAHY,KAAd;AAOA,SAAA,KAAA,GAAa,KAAA,KAAA,CAAA,IAAA,CAAb,IAAa,CAAb;AACA,SAAA,IAAA,GAAY,KAAA,IAAA,CAAA,IAAA,CAAZ,IAAY,CAAZ;AAEA,SAAA,gBAAA,GAAA,IAAA;AAEA,SAAA,YAAA,GAAoB,KAAA,YAAA,CAAA,IAAA,CAApB,IAAoB,CAApB;AACA,SAAA,aAAA,GAAqB,KAAA,aAAA,CAAA,IAAA,CAArB,IAAqB,CAArB;AACD;;;;8BAEQ;AACP,WAAA,IAAA;;AACA,WAAA,WAAA,CAAA,IAAA;AACD;;;mCAEcE,M,EAAQ;AACrBC,MAAAA,MAAM,CAAC,OAAA,MAAA,KAAPA,QAAM,CAANA;AACA,WAAA,WAAA,GAAmB,KAAA,WAAA,IAAnB,MAAA;AACA,aAAA,IAAA;AACD;;;6BAEQlB,K,EAAO;AACd,UAAI,wBAAJ,KAAA,EAAmC;AACjC,aAAA,kBAAA,GAA0BA,KAAK,CAA/B,kBAAA;AACD;;AACD,UAAI,6BAAJ,KAAA,EAAwC;AACtC,aAAA,uBAAA,GAA+BA,KAAK,CAApC,uBAAA;AACD;;AACD,UAAI,qBAAJ,KAAA,EAAgC;AAC9B,aAAA,eAAA,GAAuBA,KAAK,CAA5B,eAAA;AACD;;AACD,aAAA,IAAA;AACD;;;4BAIgB;AAAA,UAAA,KAAA,GAAA,IAAA;;AAAA,UAAXmB,IAAW,GAAA,SAAA,CAAA,MAAA,GAAA,CAAA,IAAA,SAAA,CAAA,CAAA,CAAA,KAAA,SAAA,GAAA,SAAA,CAAA,CAAA,CAAA,GAAJ,EAAI;;AACf,UAAI,KAAJ,QAAA,EAAmB;AACjB,eAAA,IAAA;AACD;;AACD,WAAA,QAAA,GAAA,IAAA;;AAGA,WAAA,mBAAA,GAAA,IAAA,CACQ,YAAM;AACV,YAAI,CAAC,KAAI,CAAL,QAAA,IAAkB,KAAI,CAA1B,YAAA,EAAyC;AACvC,iBAAA,IAAA;AACD;;AAGD,QAAA,KAAI,CAAJ,mBAAA,CAAA,IAAA;;AACA,QAAA,KAAI,CAAJ,kBAAA;;AACA,QAAA,KAAI,CAAJ,mBAAA;;AAGA,QAAA,KAAI,CAAJ,uBAAA;;AACA,QAAA,KAAI,CAAJ,mBAAA;;AAGA,QAAA,KAAI,CAAJ,0BAAA;;AACA,QAAA,KAAI,CAAJ,eAAA;;AAEA,QAAA,KAAI,CAAJ,aAAA,GAAqBC,KAAK,CAALA,WAAAA,CAAkB,KAAI,CAAtBA,EAAAA,EAA2B,CAA3BA,QAA2B,CAA3BA,IAAyC,IAAA,KAAA,CAAU,KAAI,CAAvDA,EAAyC,CAAzCA,GAArB,IAAA;AAEA,QAAA,KAAI,CAAJ,YAAA,GAAA,IAAA;AAGA,eAAO,KAAI,CAAJ,YAAA,CAAkB,KAAI,CAA7B,cAAO,CAAP;AAxBJ,OAAA,EAAA,IAAA,CA0BQ,UAAA,UAAA,EAAc;AAClB,YAAI,KAAI,CAAR,QAAA,EAAmB;AACjB,UAAA,KAAI,CAAJ,gBAAA,CAAsBC,UAAU,IAAhC,EAAA;;AACA,cAAIA,UAAU,KAAd,KAAA,EAA0B;AACxB,YAAA,KAAI,CAAJ,UAAA;AACD;AACF;AAhCL,OAAA;;AAkCA,aAAA,IAAA;AACD;;;6BAGQ;AACP,WAAA,YAAA;;AAEA,WAAA,WAAA;;AACA,WAAA,mBAAA;;AAEA,WAAA,YAAA,CAAkB,KAAlB,cAAA;;AAGA,WAAA,iBAAA;;AAIA,UAAI,KAAA,SAAA,IAAkB,KAAA,EAAA,CAAtB,MAAA,EAAsC;AACpC,aAAA,EAAA,CAAA,MAAA;AACD;;AAED,UAAI,KAAJ,iBAAA,EAA4B;AAC1B,aAAA,iBAAA,CAAA,IAAA;;AACA,aAAA,iBAAA,GAAA,IAAA;AACA,aAAA,iBAAA,GAAA,IAAA;AACD;;AAED,WAAA,UAAA;;AAEA,aAAA,IAAA;AACD;;;2BAGM;AAEL,UAAI,KAAJ,QAAA,EAAmB;AACjB,aAAA,qBAAA;;AACAC,QAAAA,oBAAoB,CAAC,KAArBA,iBAAoB,CAApBA;AACA,aAAA,iBAAA,GAAA,IAAA;AACA,aAAA,iBAAA,GAAA,IAAA;AACA,aAAA,iBAAA,GAAA,IAAA;AACA,aAAA,QAAA,GAAA,KAAA;AACD;;AACD,aAAA,IAAA;AACD;;;mCAEcC,Q,EAAU;AACvB,WAAA,QAAA,GAAA,QAAA;AAEA,aAAO,KAAP,QAAA;AACD;;;qCAEgB;AACf,WAAA,QAAA,GAAA,IAAA;AACD;;;oCAEe;AAAA,UAAA,MAAA,GAAA,IAAA;;AACd,WAAA,cAAA,CAAA,eAAA;;AAEA,UAAI,CAAC,KAAL,iBAAA,EAA6B;AAC3B,aAAA,iBAAA,GAAyB,IAAA,OAAA,CAAY,UAAA,OAAA,EAAW;AAC9C,UAAA,MAAI,CAAJ,iBAAA,GAAA,OAAA;AADF,SAAyB,CAAzB;AAGD;;AACD,aAAO,KAAP,iBAAA;AACD;;;;;;;;;AAGC,qBAAA,cAAA,CAAA,WAAA;;uBAEM,KAAA,aAAA,E;;;iDAEC,KAAA,EAAA,CAAA,MAAA,CAAA,SAAA,E;;;;;;;;;;;;;;;;;;sCAGgB;AAAA,UAAA,WAAA;;AACvB,aAAO,CAAA,WAAA,GAAA,KAAA,KAAA,EAAA,eAAA,CAAA,KAAA,CAAA,WAAA,EAAP,SAAO,CAAP;AACD;;;mCAEqB;AAAA,UAAA,YAAA;;AACpB,aAAO,CAAA,YAAA,GAAA,KAAA,KAAA,EAAA,YAAA,CAAA,KAAA,CAAA,YAAA,EAAP,SAAO,CAAP;AACD;;;+BAEiB;AAAA,UAAA,YAAA;;AAChB,aAAO,CAAA,YAAA,GAAA,KAAA,KAAA,EAAA,QAAA,CAAA,KAAA,CAAA,YAAA,EAAP,SAAO,CAAP;AACD;;;iCAEmB;AAAA,UAAA,YAAA;;AAClB,aAAO,CAAA,YAAA,GAAA,KAAA,KAAA,EAAA,UAAA,CAAA,KAAA,CAAA,YAAA,EAAP,SAAO,CAAP;AACD;;;wCAImBC,E,EAAsB;AAAA,UAAlBC,YAAkB,GAAA,SAAA,CAAA,MAAA,GAAA,CAAA,IAAA,SAAA,CAAA,CAAA,CAAA,KAAA,SAAA,GAAA,SAAA,CAAA,CAAA,CAAA,GAAH,CAAG;AACxC,UAAMC,OAAO,GAAGC,QAAQ,CAARA,cAAAA,CAAhB,EAAgBA,CAAhB;AACA,aAAOD,OAAO,GAAGE,MAAM,CAACF,OAAO,CAAjB,KAAS,CAAT,GAAd,YAAA;AACD;;;wCAGmB;AAClBV,MAAAA,GAAG,CAAHA,OAAAA,CAAAA,iCAAAA,EAAAA,wBAAAA;AACA,aAAA,IAAA;AACD;;;iCAIY;AAAA,UAAA,MAAA,GAAA,IAAA;;AACX,UAAMa,WAAW,GAAG,SAAdA,WAAc,GAAM;AACxB,YAAI,CAAC,MAAI,CAAT,QAAA,EAAoB;AAClB;AACD;;AACD,QAAA,MAAI,CAAJ,MAAA;;AACA,QAAA,MAAI,CAAJ,iBAAA,GAAyB,MAAI,CAAJ,sBAAA,CAAzB,WAAyB,CAAzB;AALF,OAAA;;AASAP,MAAAA,oBAAoB,CAAC,KAArBA,iBAAoB,CAApBA;AACA,WAAA,iBAAA,GAAyB,KAAA,sBAAA,CAAzB,WAAyB,CAAzB;AACD;;;0CAIqB;AACpB,UAAI,CAAC,KAAL,gBAAA,EAA4B;AAC1B,aAAA,gBAAA,GAAwB1B,MAAM,GAC1B,IAAA,OAAA,CAAY,UAAA,OAAA,EAAA,MAAA,EAAqB;AAC/B,cAAIA,MAAM,IAAI+B,QAAQ,CAARA,UAAAA,KAAd,UAAA,EAAkD;AAChDG,YAAAA,OAAO,CAAPA,QAAO,CAAPA;AACA;AACD;;AACDC,UAAAA,MAAM,CAANA,gBAAAA,CAAAA,MAAAA,EAAgC,YAAM;AACpCD,YAAAA,OAAO,CAAPA,QAAO,CAAPA;AADFC,WAAAA;AANwB,SAC1B,CAD0B,GAU1BC,OAAO,CAAPA,OAAAA,CAVJ,EAUIA,CAVJ;AAWD;;AACD,aAAO,KAAP,gBAAA;AACD;;;gCAEWC,O,EAAS;AACnB,UAAI,KAAJ,OAAA,EAAkB;AAChB,aAAA,OAAA,CAAA,QAAA;AACA,aAAA,OAAA,CAAA,aAAA,GAAA,IAAA;AACD;;AAGD,UAAA,OAAA,EAAa;AACXA,QAAAA,OAAO,CAAPA,aAAAA,GAAAA,IAAAA;AACD;;AAED,WAAA,OAAA,GAAA,OAAA;AACD;;;2CAEsBC,mB,EAAqB;AAE1C,UAAI,KAAA,OAAA,IAAgB,KAAA,OAAA,CAAA,qBAAA,CAApB,mBAAoB,CAApB,EAA6E;AAC3E;AACD;;AAEDC,MAAAA,qBAAqB,CAArBA,mBAAqB,CAArBA;AACD;;;mCAIqB;AAEpB,UAAI,KAAJ,OAAA,EAAkB;AAAA,YAAA,aAAA;;AAChB,SAAA,aAAA,GAAA,KAAA,OAAA,EAAA,YAAA,CAAA,KAAA,CAAA,aAAA,EAAA,SAAA;;AACA;AACD;;AAGD,WAAA,QAAA,CAAA,KAAA,CAAA,IAAA,EAAA,SAAA;AAED;;;wCAEmB;AAClB,WAAA,WAAA,GAAA,IAAA;AACD;;;kCAEa;AACZ,UAAI,KAAJ,aAAA,EAAwB;AAEtB,aAAA,aAAA,CAAmB,KAAnB,cAAA;AAFF,OAAA,MAIO;AACL,aAAA,0BAAA;;AACA,aAAA,eAAA;;AACA,aAAA,kBAAA;AACD;AACF;;;8CAGyB;AACxB,WAAA,cAAA,GAAsB;AACpB5B,QAAAA,EAAE,EAAE,KADgB,EAAA;AAGpB6B,QAAAA,IAAI,EAAE,KAHc,IAAA;AAIpBC,QAAAA,MAAM,EAAE,KAAA,EAAA,CAJY,MAAA;AAKpBC,QAAAA,WAAW,EAAE,KALO,WAAA;AAQpBvB,QAAAA,eAAe,EAAE,KARG,eAAA;AASpBwB,QAAAA,WAAW,EATS,IAAA;AAYpBC,QAAAA,SAAS,EAAEC,IAAI,CAZK,GAYTA,EAZS;AAapBC,QAAAA,UAAU,EAbU,CAAA;AAcpBC,QAAAA,IAAI,EAdgB,CAAA;AAepBC,QAAAA,IAAI,EAfgB,CAAA;AAkBpBC,QAAAA,IAAI,EAlBgB,CAAA;AAqBpBC,QAAAA,SAAS,EAAE,KArBS,QAAA;AAsBpBC,QAAAA,KAAK,EAtBe,IAAA;AAuBpBC,QAAAA,cAAc,EAvBM,IAAA;AAwBpBC,QAAAA,cAAc,EAAE;AAxBI,OAAtB;AA0BD;;;0CAGqB;AAAA,UAAA,qBAAA,GACY,KADZ,iBACY,EADZ;AAAA,UACbC,KADa,GAAA,qBAAA,CAAA,KAAA;AAAA,UACNC,MADM,GAAA,qBAAA,CAAA,MAAA;AAAA,UACEC,MADF,GAAA,qBAAA,CAAA,MAAA;;AAEpB,UAAIF,KAAK,KAAK,KAAA,cAAA,CAAVA,KAAAA,IAAuCC,MAAM,KAAK,KAAA,cAAA,CAAtD,MAAA,EAAkF;AAChF,aAAA,cAAA,CAAA,wBAAA;AACD;;AACD,UAAIC,MAAM,KAAK,KAAA,cAAA,CAAf,MAAA,EAA2C;AACzC,aAAA,cAAA,CAAA,+BAAA;AACD;;AAED,WAAA,cAAA,CAAA,KAAA,GAAA,KAAA;AACA,WAAA,cAAA,CAAA,MAAA,GAAA,MAAA;AACA,WAAA,cAAA,CAAA,MAAA,GAAA,MAAA;AAEA,WAAA,cAAA,CAAA,WAAA,GAAkC,KAAlC,WAAA;AAGA,WAAA,cAAA,CAAA,UAAA,GAAiCX,IAAI,CAAJA,GAAAA,KAAa,KAAA,cAAA,CAA9C,SAAA;;AAEA,UAAI,KAAJ,QAAA,EAAmB;AACjB,aAAA,QAAA,CAAA,MAAA,CAAqB,KAAA,cAAA,CAArB,UAAA;AACD;;AAED,WAAA,cAAA,CAAA,IAAA,GAA2BY,IAAI,CAAJA,KAAAA,CAAY,KAAA,cAAA,CAAA,IAAA,GAAD,IAAC,GAAvC,EAA2BA,CAA3B;AACA,WAAA,cAAA,CAAA,IAAA;AAGA,WAAA,cAAA,CAAA,IAAA,GAA2B,KAAA,QAAA,GACvB,KAAA,QAAA,CADuB,OACvB,EADuB,GAEvB,KAAA,cAAA,CAFJ,UAAA;AAKA,WAAA,cAAA,CAAA,UAAA,GAAiC,KAAjC,SAAA;AACD;;;4CAEuB;AAEtB,WAAA,UAAA,CAAgB,KAAhB,cAAA;AAED;;;qCAGgBhC,U,EAAY;AAC3B,UAAI,OAAA,CAAA,UAAA,CAAA,KAAA,QAAA,IAAkCA,UAAU,KAAhD,IAAA,EAA2D;AACzD,aAAA,cAAA,GAAsBiC,MAAM,CAANA,MAAAA,CAAAA,EAAAA,EAAkB,KAAlBA,cAAAA,EAAtB,UAAsBA,CAAtB;AACD;AACF;;;wCAGmBnC,I,EAAM;AACxB,WAAA,SAAA,GACEA,IAAI,CAAJA,MAAAA,IACA,OAAA,eAAA,KADAA,WAAAA,IAEAA,IAAI,CAAJA,MAAAA,YAHF,eAAA;AAMAA,MAAAA,IAAI,GAAGmC,MAAM,CAANA,MAAAA,CAAAA,EAAAA,EAAAA,IAAAA,EAAwB,KAAA,KAAA,CAA/BnC,SAAOmC,CAAPnC;AACA,WAAA,EAAA,GAAU,KAAA,KAAA,CAAA,EAAA,GAAgBoC,mBAAmB,CAAC,KAAA,KAAA,CAAD,EAAA,EAAnC,IAAmC,CAAnC,GAA2D,KAAA,eAAA,CAArE,IAAqE,CAArE;;AAEA,UAAI,CAACC,OAAO,CAAC,KAAb,EAAY,CAAZ,EAAuB;AACrB,cAAM,IAAA,KAAA,CAAN,0DAAM,CAAN;AACD;;AAGDC,MAAAA,eAAe,CAAC,KAAhBA,EAAe,CAAfA;;AAEA,WAAA,cAAA;AACD;;;qCAEgB;AACf,UAAI,KAAA,EAAA,CAAA,MAAA,IAAkB,KAAA,KAAA,CAAtB,SAAA,EAA4C;AAE1C,YAAMC,UAAU,GAAG/B,QAAQ,CAARA,aAAAA,CAAnB,KAAmBA,CAAnB;AACAA,QAAAA,QAAQ,CAARA,IAAAA,CAAAA,WAAAA,CAAAA,UAAAA;AACA+B,QAAAA,UAAU,CAAVA,KAAAA,CAAAA,QAAAA,GAAAA,UAAAA;AACA,YAAMC,GAAG,GAAGhC,QAAQ,CAARA,aAAAA,CAAZ,KAAYA,CAAZ;AACAgC,QAAAA,GAAG,CAAHA,KAAAA,CAAAA,QAAAA,GAAAA,UAAAA;AACAA,QAAAA,GAAG,CAAHA,KAAAA,CAAAA,IAAAA,GAAAA,MAAAA;AACAA,QAAAA,GAAG,CAAHA,KAAAA,CAAAA,MAAAA,GAAAA,MAAAA;AACAA,QAAAA,GAAG,CAAHA,KAAAA,CAAAA,KAAAA,GAAAA,OAAAA;AACAA,QAAAA,GAAG,CAAHA,KAAAA,CAAAA,UAAAA,GAAAA,OAAAA;AACAD,QAAAA,UAAU,CAAVA,WAAAA,CAAuB,KAAA,EAAA,CAAvBA,MAAAA;AACAA,QAAAA,UAAU,CAAVA,WAAAA,CAAAA,GAAAA;AACA,YAAME,IAAI,GAAG,KAAA,KAAA,CAAA,SAAA,CAAb,GAAa,CAAb;;AACA,YAAA,IAAA,EAAU;AACRD,UAAAA,GAAG,CAAHA,SAAAA,GAAAA,IAAAA;AACD;AACF;AACF;;;wCAEmB;AAElB,UAAMT,KAAK,GAAG,KAAA,EAAA,CAAd,kBAAA;AACA,UAAMC,MAAM,GAAG,KAAA,EAAA,CAAf,mBAAA;AAGA,UAAIC,MAAM,GAAV,CAAA;AANkB,UAOXf,MAPW,GAOD,KAPC,EAOD,CAPC,MAAA;;AASlB,UAAIA,MAAM,IAAIA,MAAM,CAApB,YAAA,EAAmC;AACjCe,QAAAA,MAAM,GAAGf,MAAM,CAANA,WAAAA,GAAqBA,MAAM,CAApCe,YAAAA;AADF,OAAA,MAEO,IAAIF,KAAK,GAALA,CAAAA,IAAaC,MAAM,GAAvB,CAAA,EAA6B;AAClCC,QAAAA,MAAM,GAAGF,KAAK,GAAdE,MAAAA;AACD;;AAED,aAAO;AAACF,QAAAA,KAAK,EAAN,KAAA;AAAQC,QAAAA,MAAM,EAAd,MAAA;AAAgBC,QAAAA,MAAM,EAANA;AAAhB,OAAP;AACD;;;sCAGiB;AAChB,UAAI,KAAJ,kBAAA,EAA6B;AAC3B,aAAA,EAAA,CAAA,QAAA,CAAA,CAAA,EAAA,CAAA,EAAuB,KAAA,EAAA,CAAvB,kBAAA,EAAmD,KAAA,EAAA,CAAnD,mBAAA;AACD;AACF;;;iDAI4B;AAC3B,UAAI,KAAJ,uBAAA,EAAkC;AAChCS,QAAAA,eAAe,CAAC,KAAD,EAAA,EAAU;AAAC9C,UAAAA,eAAe,EAAE,KAAKA;AAAvB,SAAV,CAAf8C;AACD;AACF;;;yCAGoB;AAEnB,UAAI,KAAA,KAAA,CAAJ,iBAAA,EAAkC;AAChC,aAAA,WAAA,GAAmB,IAAA,WAAA,CAAgB,KAAnC,EAAmB,CAAnB;AACD;AACF;;;yCAEoB;AACnB,UAAI,KAAJ,WAAA,EAAsB;AACpB,aAAA,WAAA,CAAA,MAAA,CAAwB;AACtBX,UAAAA,KAAK,EAAE,KAAA,EAAA,CADe,kBAAA;AAEtBC,UAAAA,MAAM,EAAE,KAAA,EAAA,CAAQW;AAFM,SAAxB;AAID;AACF;;;mCAEc;AACb,WAAA,SAAA,CAAA,OAAA;AACA,WAAA,SAAA,CAAA,SAAA;;AAKA,UACE,KAAA,aAAA,IACA,KAAA,aAAA,CADA,iBACA,EADA,IAEA,CAAC,KAAA,aAAA,CAHH,eAGG,EAHH,EAIE;AACA,aAAA,KAAA,CAAA,GAAA,CAAA,UAAA,EAAA,OAAA,CAAmC,KAAA,aAAA,CAAnC,oBAAmC,EAAnC;AACD;;AAED,UAAI,KAAJ,aAAA,EAAwB;AAEtB,aAAA,aAAA,CAAA,qBAAA;AACD;;AAED,WAAA,OAAA,CAAA,SAAA;AACD;;;iCAEY;AACX,WAAA,OAAA,CAAA,OAAA;;AAEA,UAAI,KAAJ,aAAA,EAAwB;AAEtB,aAAA,aAAA,CAAA,GAAA;AACD;AACF;;;0CAIqB;AAAA,UACbzB,MADa,GACH,KADG,EACH,CADG,MAAA;;AAEpB,UAAA,MAAA,EAAY;AACVA,QAAAA,MAAM,CAANA,gBAAAA,CAAAA,WAAAA,EAAqC,KAArCA,YAAAA;AACAA,QAAAA,MAAM,CAANA,gBAAAA,CAAAA,YAAAA,EAAsC,KAAtCA,aAAAA;AACD;AACF;;;iCAEY0B,C,EAAG;AACd,WAAA,cAAA,CAAA,cAAA,GAAqC,CAACA,CAAC,CAAF,OAAA,EAAYA,CAAC,CAAlD,OAAqC,CAArC;AACD;;;kCACaA,C,EAAG;AACf,WAAA,cAAA,CAAA,cAAA,GAAA,IAAA;AACD;;;;;;SAxiBkBhE,a","sourcesContent":["/* global window, OffscreenCanvas */\nimport {\n  isWebGL,\n  createGLContext,\n  instrumentGLContext,\n  resizeGLContext,\n  resetParameters\n} from '@luma.gl/gltools';\nimport {\n  requestAnimationFrame,\n  cancelAnimationFrame,\n  Query,\n  lumaStats,\n  // TODO - remove dependency on framebuffer (bundle size impact)\n  Framebuffer,\n  log,\n  assert\n} from '@luma.gl/webgl';\nimport {isBrowser} from 'probe.gl/env';\n\nconst isPage = isBrowser() && typeof document !== 'undefined';\n\nlet statIdCounter = 0;\n\nexport default class AnimationLoop {\n  /*\n   * @param {HTMLCanvasElement} canvas - if provided, width and height will be passed to context\n   */\n  constructor(props = {}) {\n    const {\n      onCreateContext = opts => createGLContext(opts),\n      onAddHTML = null,\n      onInitialize = () => {},\n      onRender = () => {},\n      onFinalize = () => {},\n\n      gl = null,\n      glOptions = {},\n      debug = false,\n\n      createFramebuffer = false,\n\n      // view parameters\n      autoResizeViewport = true,\n      autoResizeDrawingBuffer = true,\n      stats = lumaStats.get(`animation-loop-${statIdCounter++}`)\n    } = props;\n\n    let {useDevicePixels = true} = props;\n\n    if ('useDevicePixelRatio' in props) {\n      log.deprecated('useDevicePixelRatio', 'useDevicePixels')();\n      useDevicePixels = props.useDevicePixelRatio;\n    }\n\n    this.props = {\n      onCreateContext,\n      onAddHTML,\n      onInitialize,\n      onRender,\n      onFinalize,\n\n      gl,\n      glOptions,\n      debug,\n      createFramebuffer\n    };\n\n    // state\n    this.gl = gl;\n    this.needsRedraw = null;\n    this.timeline = null;\n    this.stats = stats;\n    this.cpuTime = this.stats.get('CPU Time');\n    this.gpuTime = this.stats.get('GPU Time');\n    this.frameRate = this.stats.get('Frame Rate');\n\n    this._initialized = false;\n    this._running = false;\n    this._animationFrameId = null;\n    this._nextFramePromise = null;\n    this._resolveNextFrame = null;\n    this._cpuStartTime = 0;\n\n    this.setProps({\n      autoResizeViewport,\n      autoResizeDrawingBuffer,\n      useDevicePixels\n    });\n\n    // Bind methods\n    this.start = this.start.bind(this);\n    this.stop = this.stop.bind(this);\n\n    this._pageLoadPromise = null;\n\n    this._onMousemove = this._onMousemove.bind(this);\n    this._onMouseleave = this._onMouseleave.bind(this);\n  }\n\n  delete() {\n    this.stop();\n    this._setDisplay(null);\n  }\n\n  setNeedsRedraw(reason) {\n    assert(typeof reason === 'string');\n    this.needsRedraw = this.needsRedraw || reason;\n    return this;\n  }\n\n  setProps(props) {\n    if ('autoResizeViewport' in props) {\n      this.autoResizeViewport = props.autoResizeViewport;\n    }\n    if ('autoResizeDrawingBuffer' in props) {\n      this.autoResizeDrawingBuffer = props.autoResizeDrawingBuffer;\n    }\n    if ('useDevicePixels' in props) {\n      this.useDevicePixels = props.useDevicePixels;\n    }\n    return this;\n  }\n\n  // Starts a render loop if not already running\n  // @param {Object} context - contains frame specific info (E.g. tick, width, height, etc)\n  start(opts = {}) {\n    if (this._running) {\n      return this;\n    }\n    this._running = true;\n    // console.debug(`Starting ${this.constructor.name}`);\n    // Wait for start promise before rendering frame\n    this._getPageLoadPromise()\n      .then(() => {\n        if (!this._running || this._initialized) {\n          return null;\n        }\n\n        // Create the WebGL context\n        this._createWebGLContext(opts);\n        this._createFramebuffer();\n        this._startEventHandling();\n\n        // Initialize the callback data\n        this._initializeCallbackData();\n        this._updateCallbackData();\n\n        // Default viewport setup, in case onInitialize wants to render\n        this._resizeCanvasDrawingBuffer();\n        this._resizeViewport();\n\n        this._gpuTimeQuery = Query.isSupported(this.gl, ['timers']) ? new Query(this.gl) : null;\n\n        this._initialized = true;\n\n        // Note: onIntialize can return a promise (in case it needs to load resources)\n        return this.onInitialize(this.animationProps);\n      })\n      .then(appContext => {\n        if (this._running) {\n          this._addCallbackData(appContext || {});\n          if (appContext !== false) {\n            this._startLoop();\n          }\n        }\n      });\n    return this;\n  }\n\n  // Redraw now\n  redraw() {\n    this._beginTimers();\n\n    this._setupFrame();\n    this._updateCallbackData();\n\n    this._renderFrame(this.animationProps);\n\n    // clear needsRedraw flag\n    this._clearNeedsRedraw();\n\n    // https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/commit\n    // Chrome's offscreen canvas does not require gl.commit\n    if (this.offScreen && this.gl.commit) {\n      this.gl.commit();\n    }\n\n    if (this._resolveNextFrame) {\n      this._resolveNextFrame(this);\n      this._nextFramePromise = null;\n      this._resolveNextFrame = null;\n    }\n\n    this._endTimers();\n\n    return this;\n  }\n\n  // Stops a render loop if already running, finalizing\n  stop() {\n    // console.debug(`Stopping ${this.constructor.name}`);\n    if (this._running) {\n      this._finalizeCallbackData();\n      cancelAnimationFrame(this._animationFrameId);\n      this._nextFramePromise = null;\n      this._resolveNextFrame = null;\n      this._animationFrameId = null;\n      this._running = false;\n    }\n    return this;\n  }\n\n  attachTimeline(timeline) {\n    this.timeline = timeline;\n\n    return this.timeline;\n  }\n\n  detachTimeline() {\n    this.timeline = null;\n  }\n\n  waitForRender() {\n    this.setNeedsRedraw('waitForRender');\n\n    if (!this._nextFramePromise) {\n      this._nextFramePromise = new Promise(resolve => {\n        this._resolveNextFrame = resolve;\n      });\n    }\n    return this._nextFramePromise;\n  }\n\n  async toDataURL() {\n    this.setNeedsRedraw('toDataURL');\n\n    await this.waitForRender();\n\n    return this.gl.canvas.toDataURL();\n  }\n\n  onCreateContext(...args) {\n    return this.props.onCreateContext(...args);\n  }\n\n  onInitialize(...args) {\n    return this.props.onInitialize(...args);\n  }\n\n  onRender(...args) {\n    return this.props.onRender(...args);\n  }\n\n  onFinalize(...args) {\n    return this.props.onFinalize(...args);\n  }\n\n  // DEPRECATED/REMOVED METHODS\n\n  getHTMLControlValue(id, defaultValue = 1) {\n    const element = document.getElementById(id);\n    return element ? Number(element.value) : defaultValue;\n  }\n\n  // Update parameters\n  setViewParameters() {\n    log.removed('AnimationLoop.setViewParameters', 'AnimationLoop.setProps')();\n    return this;\n  }\n\n  // PRIVATE METHODS\n\n  _startLoop() {\n    const renderFrame = () => {\n      if (!this._running) {\n        return;\n      }\n      this.redraw();\n      this._animationFrameId = this._requestAnimationFrame(renderFrame);\n    };\n\n    // cancel any pending renders to ensure only one loop can ever run\n    cancelAnimationFrame(this._animationFrameId);\n    this._animationFrameId = this._requestAnimationFrame(renderFrame);\n  }\n\n  // PRIVATE METHODS\n\n  _getPageLoadPromise() {\n    if (!this._pageLoadPromise) {\n      this._pageLoadPromise = isPage\n        ? new Promise((resolve, reject) => {\n            if (isPage && document.readyState === 'complete') {\n              resolve(document);\n              return;\n            }\n            window.addEventListener('load', () => {\n              resolve(document);\n            });\n          })\n        : Promise.resolve({});\n    }\n    return this._pageLoadPromise;\n  }\n\n  _setDisplay(display) {\n    if (this.display) {\n      this.display.delete();\n      this.display.animationLoop = null;\n    }\n\n    // store animation loop on the display\n    if (display) {\n      display.animationLoop = this;\n    }\n\n    this.display = display;\n  }\n\n  _requestAnimationFrame(renderFrameCallback) {\n    // E.g. VR display has a separate animation frame to sync with headset\n    if (this.display && this.display.requestAnimationFrame(renderFrameCallback)) {\n      return;\n    }\n\n    requestAnimationFrame(renderFrameCallback);\n  }\n\n  // Called on each frame, can be overridden to call onRender multiple times\n  // to support e.g. stereoscopic rendering\n  _renderFrame(...args) {\n    // Allow e.g. VR display to render multiple frames.\n    if (this.display) {\n      this.display._renderFrame(...args);\n      return;\n    }\n\n    // call callback\n    this.onRender(...args);\n    // end callback\n  }\n\n  _clearNeedsRedraw() {\n    this.needsRedraw = null;\n  }\n\n  _setupFrame() {\n    if (this._onSetupFrame) {\n      // call callback\n      this._onSetupFrame(this.animationProps);\n      // end callback\n    } else {\n      this._resizeCanvasDrawingBuffer();\n      this._resizeViewport();\n      this._resizeFramebuffer();\n    }\n  }\n\n  // Initialize the  object that will be passed to app callbacks\n  _initializeCallbackData() {\n    this.animationProps = {\n      gl: this.gl,\n\n      stop: this.stop,\n      canvas: this.gl.canvas,\n      framebuffer: this.framebuffer,\n\n      // Initial values\n      useDevicePixels: this.useDevicePixels,\n      needsRedraw: null,\n\n      // Animation props\n      startTime: Date.now(),\n      engineTime: 0,\n      tick: 0,\n      tock: 0,\n\n      // Timeline time for back compatibility\n      time: 0,\n\n      // Experimental\n      _timeline: this.timeline,\n      _loop: this,\n      _animationLoop: this,\n      _mousePosition: null // Event props\n    };\n  }\n\n  // Update the context object that will be passed to app callbacks\n  _updateCallbackData() {\n    const {width, height, aspect} = this._getSizeAndAspect();\n    if (width !== this.animationProps.width || height !== this.animationProps.height) {\n      this.setNeedsRedraw('drawing buffer resized');\n    }\n    if (aspect !== this.animationProps.aspect) {\n      this.setNeedsRedraw('drawing buffer aspect changed');\n    }\n\n    this.animationProps.width = width;\n    this.animationProps.height = height;\n    this.animationProps.aspect = aspect;\n\n    this.animationProps.needsRedraw = this.needsRedraw;\n\n    // Update time properties\n    this.animationProps.engineTime = Date.now() - this.animationProps.startTime;\n\n    if (this.timeline) {\n      this.timeline.update(this.animationProps.engineTime);\n    }\n\n    this.animationProps.tick = Math.floor((this.animationProps.time / 1000) * 60);\n    this.animationProps.tock++;\n\n    // For back compatibility\n    this.animationProps.time = this.timeline\n      ? this.timeline.getTime()\n      : this.animationProps.engineTime;\n\n    // experimental\n    this.animationProps._offScreen = this.offScreen;\n  }\n\n  _finalizeCallbackData() {\n    // call callback\n    this.onFinalize(this.animationProps);\n    // end callback\n  }\n\n  // Add application's data to the app context object\n  _addCallbackData(appContext) {\n    if (typeof appContext === 'object' && appContext !== null) {\n      this.animationProps = Object.assign({}, this.animationProps, appContext);\n    }\n  }\n\n  // Either uses supplied or existing context, or calls provided callback to create one\n  _createWebGLContext(opts) {\n    this.offScreen =\n      opts.canvas &&\n      typeof OffscreenCanvas !== 'undefined' &&\n      opts.canvas instanceof OffscreenCanvas;\n\n    // Create the WebGL context if necessary\n    opts = Object.assign({}, opts, this.props.glOptions);\n    this.gl = this.props.gl ? instrumentGLContext(this.props.gl, opts) : this.onCreateContext(opts);\n\n    if (!isWebGL(this.gl)) {\n      throw new Error('AnimationLoop.onCreateContext - illegal context returned');\n    }\n\n    // Reset the WebGL context.\n    resetParameters(this.gl);\n\n    this._createInfoDiv();\n  }\n\n  _createInfoDiv() {\n    if (this.gl.canvas && this.props.onAddHTML) {\n      /* global document */\n      const wrapperDiv = document.createElement('div');\n      document.body.appendChild(wrapperDiv);\n      wrapperDiv.style.position = 'relative';\n      const div = document.createElement('div');\n      div.style.position = 'absolute';\n      div.style.left = '10px';\n      div.style.bottom = '10px';\n      div.style.width = '300px';\n      div.style.background = 'white';\n      wrapperDiv.appendChild(this.gl.canvas);\n      wrapperDiv.appendChild(div);\n      const html = this.props.onAddHTML(div);\n      if (html) {\n        div.innerHTML = html;\n      }\n    }\n  }\n\n  _getSizeAndAspect() {\n    // https://webglfundamentals.org/webgl/lessons/webgl-resizing-the-canvas.html\n    const width = this.gl.drawingBufferWidth;\n    const height = this.gl.drawingBufferHeight;\n\n    // https://webglfundamentals.org/webgl/lessons/webgl-anti-patterns.html\n    let aspect = 1;\n    const {canvas} = this.gl;\n\n    if (canvas && canvas.clientHeight) {\n      aspect = canvas.clientWidth / canvas.clientHeight;\n    } else if (width > 0 && height > 0) {\n      aspect = width / height;\n    }\n\n    return {width, height, aspect};\n  }\n\n  // Default viewport setup\n  _resizeViewport() {\n    if (this.autoResizeViewport) {\n      this.gl.viewport(0, 0, this.gl.drawingBufferWidth, this.gl.drawingBufferHeight);\n    }\n  }\n\n  // Resize the render buffer of the canvas to match canvas client size\n  // Optionally multiplying with devicePixel ratio\n  _resizeCanvasDrawingBuffer() {\n    if (this.autoResizeDrawingBuffer) {\n      resizeGLContext(this.gl, {useDevicePixels: this.useDevicePixels});\n    }\n  }\n\n  // TBD - deprecated?\n  _createFramebuffer() {\n    // Setup default framebuffer\n    if (this.props.createFramebuffer) {\n      this.framebuffer = new Framebuffer(this.gl);\n    }\n  }\n\n  _resizeFramebuffer() {\n    if (this.framebuffer) {\n      this.framebuffer.resize({\n        width: this.gl.drawingBufferWidth,\n        height: this.gl.drawingBufferHeight\n      });\n    }\n  }\n\n  _beginTimers() {\n    this.frameRate.timeEnd();\n    this.frameRate.timeStart();\n\n    // Check if timer for last frame has completed.\n    // GPU timer results are never available in the same\n    // frame they are captured.\n    if (\n      this._gpuTimeQuery &&\n      this._gpuTimeQuery.isResultAvailable() &&\n      !this._gpuTimeQuery.isTimerDisjoint()\n    ) {\n      this.stats.get('GPU Time').addTime(this._gpuTimeQuery.getTimerMilliseconds());\n    }\n\n    if (this._gpuTimeQuery) {\n      // GPU time query start\n      this._gpuTimeQuery.beginTimeElapsedQuery();\n    }\n\n    this.cpuTime.timeStart();\n  }\n\n  _endTimers() {\n    this.cpuTime.timeEnd();\n\n    if (this._gpuTimeQuery) {\n      // GPU time query end. Results will be available on next frame.\n      this._gpuTimeQuery.end();\n    }\n  }\n\n  // Event handling\n\n  _startEventHandling() {\n    const {canvas} = this.gl;\n    if (canvas) {\n      canvas.addEventListener('mousemove', this._onMousemove);\n      canvas.addEventListener('mouseleave', this._onMouseleave);\n    }\n  }\n\n  _onMousemove(e) {\n    this.animationProps._mousePosition = [e.offsetX, e.offsetY];\n  }\n  _onMouseleave(e) {\n    this.animationProps._mousePosition = null;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}