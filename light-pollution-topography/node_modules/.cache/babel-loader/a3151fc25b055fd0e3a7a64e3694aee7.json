{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport { isWebGL2 } from '@luma.gl/gltools';\nimport { Buffer, TransformFeedback } from '@luma.gl/webgl';\nimport { assert } from '@luma.gl/webgl';\n\nvar BufferTransform = function () {\n  function BufferTransform(gl) {\n    var props = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    _classCallCheck(this, BufferTransform);\n\n    this.gl = gl;\n    this.currentIndex = 0;\n    this.feedbackMap = {};\n    this.varyings = null;\n    this.bindings = [];\n    this.resources = {};\n\n    this._initialize(props);\n\n    Object.seal(this);\n  }\n\n  _createClass(BufferTransform, [{\n    key: \"setupResources\",\n    value: function setupResources(opts) {\n      var _iteratorNormalCompletion = true;\n      var _didIteratorError = false;\n      var _iteratorError = undefined;\n\n      try {\n        for (var _iterator = this.bindings[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n          var binding = _step.value;\n\n          this._setupTransformFeedback(binding, opts);\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (!_iteratorNormalCompletion && _iterator[\"return\"] != null) {\n            _iterator[\"return\"]();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n    }\n  }, {\n    key: \"updateModelProps\",\n    value: function updateModelProps() {\n      var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      var varyings = this.varyings;\n\n      if (varyings.length > 0) {\n        props = Object.assign({}, props, {\n          varyings: varyings\n        });\n      }\n\n      return props;\n    }\n  }, {\n    key: \"getDrawOptions\",\n    value: function getDrawOptions() {\n      var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      var binding = this.bindings[this.currentIndex];\n      var sourceBuffers = binding.sourceBuffers,\n          transformFeedback = binding.transformFeedback;\n      var attributes = Object.assign({}, sourceBuffers, opts.attributes);\n      return {\n        attributes: attributes,\n        transformFeedback: transformFeedback\n      };\n    }\n  }, {\n    key: \"swap\",\n    value: function swap() {\n      if (this.feedbackMap) {\n        this.currentIndex = this._getNextIndex();\n        return true;\n      }\n\n      return false;\n    }\n  }, {\n    key: \"update\",\n    value: function update() {\n      var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n      this._setupBuffers(opts);\n    }\n  }, {\n    key: \"getBuffer\",\n    value: function getBuffer(varyingName) {\n      var feedbackBuffers = this.bindings[this.currentIndex].feedbackBuffers;\n      var bufferOrParams = varyingName ? feedbackBuffers[varyingName] : null;\n\n      if (!bufferOrParams) {\n        return null;\n      }\n\n      return bufferOrParams instanceof Buffer ? bufferOrParams : bufferOrParams.buffer;\n    }\n  }, {\n    key: \"getData\",\n    value: function getData() {\n      var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},\n          varyingName = _ref.varyingName;\n\n      var buffer = this.getBuffer(varyingName);\n\n      if (buffer) {\n        return buffer.getData();\n      }\n\n      return null;\n    }\n  }, {\n    key: \"delete\",\n    value: function _delete() {\n      for (var name in this.resources) {\n        this.resources[name][\"delete\"]();\n      }\n    }\n  }, {\n    key: \"_initialize\",\n    value: function _initialize() {\n      var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n      this._setupBuffers(props);\n\n      this.varyings = props.varyings || Object.keys(this.bindings[this.currentIndex].feedbackBuffers);\n\n      if (this.varyings.length > 0) {\n        assert(isWebGL2(this.gl));\n      }\n    }\n  }, {\n    key: \"_getFeedbackBuffers\",\n    value: function _getFeedbackBuffers(props) {\n      var _props$sourceBuffers = props.sourceBuffers,\n          sourceBuffers = _props$sourceBuffers === void 0 ? {} : _props$sourceBuffers;\n      var feedbackBuffers = {};\n\n      if (this.bindings[this.currentIndex]) {\n        Object.assign(feedbackBuffers, this.bindings[this.currentIndex].feedbackBuffers);\n      }\n\n      if (this.feedbackMap) {\n        for (var sourceName in this.feedbackMap) {\n          var feedbackName = this.feedbackMap[sourceName];\n\n          if (sourceName in sourceBuffers) {\n            feedbackBuffers[feedbackName] = sourceName;\n          }\n        }\n      }\n\n      Object.assign(feedbackBuffers, props.feedbackBuffers);\n\n      for (var bufferName in feedbackBuffers) {\n        var bufferOrRef = feedbackBuffers[bufferName];\n\n        if (typeof bufferOrRef === 'string') {\n          var sourceBuffer = sourceBuffers[bufferOrRef];\n          var byteLength = sourceBuffer.byteLength,\n              usage = sourceBuffer.usage,\n              accessor = sourceBuffer.accessor;\n          feedbackBuffers[bufferName] = this._createNewBuffer(bufferName, {\n            byteLength: byteLength,\n            usage: usage,\n            accessor: accessor\n          });\n        }\n      }\n\n      return feedbackBuffers;\n    }\n  }, {\n    key: \"_setupBuffers\",\n    value: function _setupBuffers() {\n      var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      var _props$sourceBuffers2 = props.sourceBuffers,\n          sourceBuffers = _props$sourceBuffers2 === void 0 ? null : _props$sourceBuffers2;\n      Object.assign(this.feedbackMap, props.feedbackMap);\n\n      var feedbackBuffers = this._getFeedbackBuffers(props);\n\n      this._updateBindings({\n        sourceBuffers: sourceBuffers,\n        feedbackBuffers: feedbackBuffers\n      });\n    }\n  }, {\n    key: \"_setupTransformFeedback\",\n    value: function _setupTransformFeedback(binding, _ref2) {\n      var model = _ref2.model;\n      var program = model.program;\n      binding.transformFeedback = new TransformFeedback(this.gl, {\n        program: program,\n        buffers: binding.feedbackBuffers\n      });\n    }\n  }, {\n    key: \"_updateBindings\",\n    value: function _updateBindings(opts) {\n      this.bindings[this.currentIndex] = this._updateBinding(this.bindings[this.currentIndex], opts);\n\n      if (this.feedbackMap) {\n        var _this$_swapBuffers = this._swapBuffers(this.bindings[this.currentIndex]),\n            sourceBuffers = _this$_swapBuffers.sourceBuffers,\n            feedbackBuffers = _this$_swapBuffers.feedbackBuffers;\n\n        var nextIndex = this._getNextIndex();\n\n        this.bindings[nextIndex] = this._updateBinding(this.bindings[nextIndex], {\n          sourceBuffers: sourceBuffers,\n          feedbackBuffers: feedbackBuffers\n        });\n      }\n    }\n  }, {\n    key: \"_updateBinding\",\n    value: function _updateBinding(binding, opts) {\n      if (!binding) {\n        return {\n          sourceBuffers: Object.assign({}, opts.sourceBuffers),\n          feedbackBuffers: Object.assign({}, opts.feedbackBuffers)\n        };\n      }\n\n      Object.assign(binding.sourceBuffers, opts.sourceBuffers);\n      Object.assign(binding.feedbackBuffers, opts.feedbackBuffers);\n\n      if (binding.transformFeedback) {\n        binding.transformFeedback.setBuffers(binding.feedbackBuffers);\n      }\n\n      return binding;\n    }\n  }, {\n    key: \"_swapBuffers\",\n    value: function _swapBuffers(opts) {\n      if (!this.feedbackMap) {\n        return null;\n      }\n\n      var sourceBuffers = Object.assign({}, opts.sourceBuffers);\n      var feedbackBuffers = Object.assign({}, opts.feedbackBuffers);\n\n      for (var srcName in this.feedbackMap) {\n        var dstName = this.feedbackMap[srcName];\n        sourceBuffers[srcName] = opts.feedbackBuffers[dstName];\n        feedbackBuffers[dstName] = opts.sourceBuffers[srcName];\n        assert(feedbackBuffers[dstName] instanceof Buffer);\n      }\n\n      return {\n        sourceBuffers: sourceBuffers,\n        feedbackBuffers: feedbackBuffers\n      };\n    }\n  }, {\n    key: \"_createNewBuffer\",\n    value: function _createNewBuffer(name, opts) {\n      var buffer = new Buffer(this.gl, opts);\n\n      if (this.resources[name]) {\n        this.resources[name][\"delete\"]();\n      }\n\n      this.resources[name] = buffer;\n      return buffer;\n    }\n  }, {\n    key: \"_getNextIndex\",\n    value: function _getNextIndex() {\n      return (this.currentIndex + 1) % 2;\n    }\n  }]);\n\n  return BufferTransform;\n}();\n\nexport { BufferTransform as default };","map":{"version":3,"sources":["../../../src/transform/buffer-transform.js"],"names":["BufferTransform","props","Object","opts","binding","varyings","sourceBuffers","transformFeedback","attributes","varyingName","feedbackBuffers","bufferOrParams","buffer","assert","isWebGL2","feedbackName","sourceName","bufferOrRef","sourceBuffer","byteLength","usage","accessor","model","program","buffers","nextIndex","dstName","name"],"mappings":"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","sourcesContent":["import {isWebGL2} from '@luma.gl/gltools';\nimport {Buffer, TransformFeedback} from '@luma.gl/webgl';\nimport {assert} from '@luma.gl/webgl';\n\nexport default class BufferTransform {\n  constructor(gl, props = {}) {\n    this.gl = gl;\n    this.currentIndex = 0;\n    this.feedbackMap = {};\n    this.varyings = null; // varyings array\n    this.bindings = []; // each element is an object : {sourceBuffers, feedbackBuffers, transformFeedback}\n\n    this.resources = {}; // resources to be deleted\n\n    this._initialize(props);\n    Object.seal(this);\n  }\n\n  setupResources(opts) {\n    for (const binding of this.bindings) {\n      this._setupTransformFeedback(binding, opts);\n    }\n  }\n\n  updateModelProps(props = {}) {\n    const {varyings} = this;\n    if (varyings.length > 0) {\n      props = Object.assign({}, props, {varyings});\n    }\n    return props;\n  }\n\n  getDrawOptions(opts = {}) {\n    const binding = this.bindings[this.currentIndex];\n    const {sourceBuffers, transformFeedback} = binding;\n    const attributes = Object.assign({}, sourceBuffers, opts.attributes);\n\n    return {attributes, transformFeedback};\n  }\n\n  swap() {\n    if (this.feedbackMap) {\n      this.currentIndex = this._getNextIndex();\n      return true;\n    }\n    return false;\n  }\n\n  // update source and/or feedbackBuffers\n  update(opts = {}) {\n    this._setupBuffers(opts);\n  }\n\n  // returns current feedbackBuffer of given name\n  getBuffer(varyingName) {\n    const {feedbackBuffers} = this.bindings[this.currentIndex];\n    const bufferOrParams = varyingName ? feedbackBuffers[varyingName] : null;\n    if (!bufferOrParams) {\n      return null;\n    }\n    return bufferOrParams instanceof Buffer ? bufferOrParams : bufferOrParams.buffer;\n  }\n\n  getData({varyingName} = {}) {\n    const buffer = this.getBuffer(varyingName);\n    if (buffer) {\n      return buffer.getData();\n    }\n    return null;\n  }\n\n  // Delete owned resources.\n  delete() {\n    for (const name in this.resources) {\n      this.resources[name].delete();\n    }\n  }\n\n  // Private\n\n  _initialize(props = {}) {\n    this._setupBuffers(props);\n    this.varyings = props.varyings || Object.keys(this.bindings[this.currentIndex].feedbackBuffers);\n    if (this.varyings.length > 0) {\n      // if writting to buffers make sure it is WebGL2\n      assert(isWebGL2(this.gl));\n    }\n  }\n\n  // auto create feedback buffers if requested\n  _getFeedbackBuffers(props) {\n    const {sourceBuffers = {}} = props;\n    const feedbackBuffers = {};\n    if (this.bindings[this.currentIndex]) {\n      // this gurantees a partial feedback buffer set doesn't update\n      // previously set buffers during auto creation mode.\n      Object.assign(feedbackBuffers, this.bindings[this.currentIndex].feedbackBuffers);\n    }\n    if (this.feedbackMap) {\n      // feedbackMap is defined as sourceBuffer as key and feedbackBuffer name as object\n      for (const sourceName in this.feedbackMap) {\n        const feedbackName = this.feedbackMap[sourceName];\n        if (sourceName in sourceBuffers) {\n          feedbackBuffers[feedbackName] = sourceName;\n        }\n      }\n    }\n    Object.assign(feedbackBuffers, props.feedbackBuffers);\n    for (const bufferName in feedbackBuffers) {\n      const bufferOrRef = feedbackBuffers[bufferName];\n      if (typeof bufferOrRef === 'string') {\n        // Create new buffer with same layout and settings as source buffer\n        const sourceBuffer = sourceBuffers[bufferOrRef];\n        const {byteLength, usage, accessor} = sourceBuffer;\n        feedbackBuffers[bufferName] = this._createNewBuffer(bufferName, {\n          byteLength,\n          usage,\n          accessor\n        });\n      }\n    }\n\n    return feedbackBuffers;\n  }\n\n  _setupBuffers(props = {}) {\n    const {sourceBuffers = null} = props;\n    Object.assign(this.feedbackMap, props.feedbackMap);\n    const feedbackBuffers = this._getFeedbackBuffers(props);\n    this._updateBindings({sourceBuffers, feedbackBuffers});\n  }\n\n  _setupTransformFeedback(binding, {model}) {\n    const {program} = model;\n    binding.transformFeedback = new TransformFeedback(this.gl, {\n      program,\n      buffers: binding.feedbackBuffers\n    });\n  }\n\n  _updateBindings(opts) {\n    this.bindings[this.currentIndex] = this._updateBinding(this.bindings[this.currentIndex], opts);\n    if (this.feedbackMap) {\n      const {sourceBuffers, feedbackBuffers} = this._swapBuffers(this.bindings[this.currentIndex]);\n      const nextIndex = this._getNextIndex();\n      this.bindings[nextIndex] = this._updateBinding(this.bindings[nextIndex], {\n        sourceBuffers,\n        feedbackBuffers\n      });\n    }\n  }\n\n  _updateBinding(binding, opts) {\n    if (!binding) {\n      return {\n        sourceBuffers: Object.assign({}, opts.sourceBuffers),\n        feedbackBuffers: Object.assign({}, opts.feedbackBuffers)\n      };\n    }\n    Object.assign(binding.sourceBuffers, opts.sourceBuffers);\n    Object.assign(binding.feedbackBuffers, opts.feedbackBuffers);\n    if (binding.transformFeedback) {\n      binding.transformFeedback.setBuffers(binding.feedbackBuffers);\n    }\n    return binding;\n  }\n\n  _swapBuffers(opts) {\n    if (!this.feedbackMap) {\n      return null;\n    }\n    const sourceBuffers = Object.assign({}, opts.sourceBuffers);\n    const feedbackBuffers = Object.assign({}, opts.feedbackBuffers);\n    for (const srcName in this.feedbackMap) {\n      const dstName = this.feedbackMap[srcName];\n      sourceBuffers[srcName] = opts.feedbackBuffers[dstName];\n      feedbackBuffers[dstName] = opts.sourceBuffers[srcName];\n\n      // make sure the new destination buffer is a Buffer object\n      assert(feedbackBuffers[dstName] instanceof Buffer);\n    }\n    return {sourceBuffers, feedbackBuffers};\n  }\n\n  // Create a buffer and add to list of buffers to be deleted.\n  _createNewBuffer(name, opts) {\n    const buffer = new Buffer(this.gl, opts);\n    if (this.resources[name]) {\n      this.resources[name].delete();\n    }\n    this.resources[name] = buffer;\n    return buffer;\n  }\n\n  _getNextIndex() {\n    return (this.currentIndex + 1) % 2;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}