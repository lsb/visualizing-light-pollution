{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\n\nvar _marked = _regeneratorRuntime.mark(meshPrimitiveIterator);\n\nimport { getZeroOffsetArrayBuffer } from '@loaders.gl/loader-utils';\nimport GLTFScenegraph from '../gltf-scenegraph';\nimport { KHR_DRACO_MESH_COMPRESSION } from '../gltf-constants';\nimport { getGLTFAccessors, getGLTFAccessor } from '../gltf-utils/gltf-attribute-utils';\nexport function decode(_x, _x2, _x3) {\n  return _decode.apply(this, arguments);\n}\n\nfunction _decode() {\n  _decode = _asyncToGenerator(_regeneratorRuntime.mark(function _callee(gltfData, options, context) {\n    var scenegraph, promises, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, primitive;\n\n    return _regeneratorRuntime.wrap(function _callee$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            if (options.gltf.decompressMeshes) {\n              _context2.next = 2;\n              break;\n            }\n\n            return _context2.abrupt(\"return\");\n\n          case 2:\n            scenegraph = new GLTFScenegraph(gltfData);\n            promises = [];\n            _iteratorNormalCompletion4 = true;\n            _didIteratorError4 = false;\n            _iteratorError4 = undefined;\n            _context2.prev = 7;\n\n            for (_iterator4 = meshPrimitiveIterator(scenegraph)[Symbol.iterator](); !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {\n              primitive = _step4.value;\n\n              if (scenegraph.getObjectExtension(primitive, KHR_DRACO_MESH_COMPRESSION)) {\n                promises.push(decompressPrimitive(primitive, scenegraph, options, context));\n              }\n            }\n\n            _context2.next = 15;\n            break;\n\n          case 11:\n            _context2.prev = 11;\n            _context2.t0 = _context2[\"catch\"](7);\n            _didIteratorError4 = true;\n            _iteratorError4 = _context2.t0;\n\n          case 15:\n            _context2.prev = 15;\n            _context2.prev = 16;\n\n            if (!_iteratorNormalCompletion4 && _iterator4[\"return\"] != null) {\n              _iterator4[\"return\"]();\n            }\n\n          case 18:\n            _context2.prev = 18;\n\n            if (!_didIteratorError4) {\n              _context2.next = 21;\n              break;\n            }\n\n            throw _iteratorError4;\n\n          case 21:\n            return _context2.finish(18);\n\n          case 22:\n            return _context2.finish(15);\n\n          case 23:\n            _context2.next = 25;\n            return Promise.all(promises);\n\n          case 25:\n            scenegraph.removeExtension(KHR_DRACO_MESH_COMPRESSION);\n\n          case 26:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee, null, [[7, 11, 15, 23], [16,, 18, 22]]);\n  }));\n  return _decode.apply(this, arguments);\n}\n\nexport function encode(gltfData) {\n  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  var scenegraph = new GLTFScenegraph(gltfData);\n  var _iteratorNormalCompletion = true;\n  var _didIteratorError = false;\n  var _iteratorError = undefined;\n\n  try {\n    for (var _iterator = (scenegraph.json.meshes || [])[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n      var mesh = _step.value;\n      compressMesh(mesh, options);\n      scenegraph.addRequiredExtension(KHR_DRACO_MESH_COMPRESSION);\n    }\n  } catch (err) {\n    _didIteratorError = true;\n    _iteratorError = err;\n  } finally {\n    try {\n      if (!_iteratorNormalCompletion && _iterator[\"return\"] != null) {\n        _iterator[\"return\"]();\n      }\n    } finally {\n      if (_didIteratorError) {\n        throw _iteratorError;\n      }\n    }\n  }\n}\n\nfunction decompressPrimitive(_x4, _x5, _x6, _x7) {\n  return _decompressPrimitive.apply(this, arguments);\n}\n\nfunction _decompressPrimitive() {\n  _decompressPrimitive = _asyncToGenerator(_regeneratorRuntime.mark(function _callee2(primitive, scenegraph, options, context) {\n    var compressedPrimitive, buffer, bufferCopy, parse, decodedData;\n    return _regeneratorRuntime.wrap(function _callee2$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            compressedPrimitive = scenegraph.getObjectExtension(primitive, KHR_DRACO_MESH_COMPRESSION);\n            buffer = scenegraph.getTypedArrayForBufferView(compressedPrimitive.bufferView);\n            bufferCopy = getZeroOffsetArrayBuffer(buffer.buffer, buffer.byteOffset);\n            parse = context.parse;\n            _context3.next = 6;\n            return parse(bufferCopy, [], options, context);\n\n          case 6:\n            decodedData = _context3.sent;\n            primitive.attributes = getGLTFAccessors(decodedData.attributes);\n\n            if (decodedData.indices) {\n              primitive.indices = getGLTFAccessor(decodedData.indices);\n            }\n\n            checkPrimitive(primitive);\n\n          case 10:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, _callee2);\n  }));\n  return _decompressPrimitive.apply(this, arguments);\n}\n\nfunction compressMesh(attributes, indices) {\n  var mode = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 4;\n  var options = arguments.length > 3 ? arguments[3] : undefined;\n  var context = arguments.length > 4 ? arguments[4] : undefined;\n\n  if (!options.DracoWriter || !options.DracoLoader) {\n    throw new Error('DracoWriter/DracoLoader not available');\n  }\n\n  var compressedData = options.DracoWriter.encodeSync({\n    attributes: attributes\n  });\n  var parseSync = context.parseSync;\n  var decodedData = parseSync({\n    attributes: attributes\n  });\n\n  var fauxAccessors = options._addFauxAttributes(decodedData.attributes);\n\n  var bufferViewIndex = options.addBufferView(compressedData);\n  var glTFMesh = {\n    primitives: [{\n      attributes: fauxAccessors,\n      mode: mode,\n      extensions: _defineProperty({}, KHR_DRACO_MESH_COMPRESSION, {\n        bufferView: bufferViewIndex,\n        attributes: fauxAccessors\n      })\n    }]\n  };\n  return glTFMesh;\n}\n\nfunction checkPrimitive(primitive) {\n  if (!primitive.attributes && Object.keys(primitive.attributes).length > 0) {\n    throw new Error('Empty glTF primitive detected: Draco decompression failure?');\n  }\n}\n\nfunction meshPrimitiveIterator(scenegraph) {\n  var _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, mesh, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, primitive;\n\n  return _regeneratorRuntime.wrap(function meshPrimitiveIterator$(_context) {\n    while (1) {\n      switch (_context.prev = _context.next) {\n        case 0:\n          _iteratorNormalCompletion2 = true;\n          _didIteratorError2 = false;\n          _iteratorError2 = undefined;\n          _context.prev = 3;\n          _iterator2 = (scenegraph.json.meshes || [])[Symbol.iterator]();\n\n        case 5:\n          if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {\n            _context.next = 36;\n            break;\n          }\n\n          mesh = _step2.value;\n          _iteratorNormalCompletion3 = true;\n          _didIteratorError3 = false;\n          _iteratorError3 = undefined;\n          _context.prev = 10;\n          _iterator3 = mesh.primitives[Symbol.iterator]();\n\n        case 12:\n          if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {\n            _context.next = 19;\n            break;\n          }\n\n          primitive = _step3.value;\n          _context.next = 16;\n          return primitive;\n\n        case 16:\n          _iteratorNormalCompletion3 = true;\n          _context.next = 12;\n          break;\n\n        case 19:\n          _context.next = 25;\n          break;\n\n        case 21:\n          _context.prev = 21;\n          _context.t0 = _context[\"catch\"](10);\n          _didIteratorError3 = true;\n          _iteratorError3 = _context.t0;\n\n        case 25:\n          _context.prev = 25;\n          _context.prev = 26;\n\n          if (!_iteratorNormalCompletion3 && _iterator3[\"return\"] != null) {\n            _iterator3[\"return\"]();\n          }\n\n        case 28:\n          _context.prev = 28;\n\n          if (!_didIteratorError3) {\n            _context.next = 31;\n            break;\n          }\n\n          throw _iteratorError3;\n\n        case 31:\n          return _context.finish(28);\n\n        case 32:\n          return _context.finish(25);\n\n        case 33:\n          _iteratorNormalCompletion2 = true;\n          _context.next = 5;\n          break;\n\n        case 36:\n          _context.next = 42;\n          break;\n\n        case 38:\n          _context.prev = 38;\n          _context.t1 = _context[\"catch\"](3);\n          _didIteratorError2 = true;\n          _iteratorError2 = _context.t1;\n\n        case 42:\n          _context.prev = 42;\n          _context.prev = 43;\n\n          if (!_iteratorNormalCompletion2 && _iterator2[\"return\"] != null) {\n            _iterator2[\"return\"]();\n          }\n\n        case 45:\n          _context.prev = 45;\n\n          if (!_didIteratorError2) {\n            _context.next = 48;\n            break;\n          }\n\n          throw _iteratorError2;\n\n        case 48:\n          return _context.finish(45);\n\n        case 49:\n          return _context.finish(42);\n\n        case 50:\n        case \"end\":\n          return _context.stop();\n      }\n    }\n  }, _marked, null, [[3, 38, 42, 50], [10, 21, 25, 33], [26,, 28, 32], [43,, 45, 49]]);\n}","map":{"version":3,"sources":["../../../../src/lib/extensions/KHR_draco_mesh_compression.js"],"names":["options","scenegraph","promises","primitive","meshPrimitiveIterator","decompressPrimitive","Promise","mesh","compressMesh","compressedPrimitive","buffer","bufferCopy","getZeroOffsetArrayBuffer","parse","context","decodedData","getGLTFAccessors","getGLTFAccessor","checkPrimitive","mode","compressedData","attributes","parseSync","fauxAccessors","bufferViewIndex","glTFMesh","primitives","extensions","bufferView","Object"],"mappings":"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","sourcesContent":["// https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_draco_mesh_compression\n// Only TRIANGLES: 0x0004 and TRIANGLE_STRIP: 0x0005 are supported\n\n/* eslint-disable camelcase */\nimport {getZeroOffsetArrayBuffer} from '@loaders.gl/loader-utils';\nimport GLTFScenegraph from '../gltf-scenegraph';\nimport {KHR_DRACO_MESH_COMPRESSION} from '../gltf-constants';\nimport {getGLTFAccessors, getGLTFAccessor} from '../gltf-utils/gltf-attribute-utils';\n\n// Note: We have a \"soft dependency\" on Draco to avoid bundling it when not needed\nexport async function decode(gltfData, options, context) {\n  if (!options.gltf.decompressMeshes) {\n    return;\n  }\n\n  const scenegraph = new GLTFScenegraph(gltfData);\n  const promises = [];\n  for (const primitive of meshPrimitiveIterator(scenegraph)) {\n    if (scenegraph.getObjectExtension(primitive, KHR_DRACO_MESH_COMPRESSION)) {\n      promises.push(decompressPrimitive(primitive, scenegraph, options, context));\n    }\n  }\n\n  // Decompress meshes in parallel\n  await Promise.all(promises);\n\n  // We have now decompressed all primitives, so remove the top-level extensions\n  scenegraph.removeExtension(KHR_DRACO_MESH_COMPRESSION);\n}\n\nexport function encode(gltfData, options = {}) {\n  const scenegraph = new GLTFScenegraph(gltfData);\n\n  for (const mesh of scenegraph.json.meshes || []) {\n    // eslint-disable-next-line camelcase\n    compressMesh(mesh, options);\n    // NOTE: Only add the extension if something was actually compressed\n    scenegraph.addRequiredExtension(KHR_DRACO_MESH_COMPRESSION);\n  }\n}\n\n// DECODE\n\n// Unpacks one mesh primitive and removes the extension from the primitive\n// DracoDecoder needs to be imported and registered by app\n// Returns: Promise that resolves when all pending draco decoder jobs for this mesh complete\n\n// TODO - Implement fallback behavior per KHR_DRACO_MESH_COMPRESSION spec\n\nasync function decompressPrimitive(primitive, scenegraph, options, context) {\n  const compressedPrimitive = scenegraph.getObjectExtension(primitive, KHR_DRACO_MESH_COMPRESSION);\n\n  const buffer = scenegraph.getTypedArrayForBufferView(compressedPrimitive.bufferView);\n  // TODO - parse does not yet deal well with byte offsets embedded in typed arrays. Copy buffer\n  // TODO - remove when `parse` is fixed to handle `byteOffset`s\n  const bufferCopy = getZeroOffsetArrayBuffer(buffer.buffer, buffer.byteOffset); // , buffer.byteLength);\n\n  // this will generate an exception if DracoLoader is not installed\n  const {parse} = context;\n  const decodedData = await parse(bufferCopy, [], options, context);\n\n  primitive.attributes = getGLTFAccessors(decodedData.attributes);\n  if (decodedData.indices) {\n    primitive.indices = getGLTFAccessor(decodedData.indices);\n  }\n\n  // Extension has been processed, delete it\n  // delete primitive.extensions[KHR_DRACO_MESH_COMPRESSION];\n\n  checkPrimitive(primitive);\n}\n\n// ENCODE\n\n// eslint-disable-next-line max-len\n// Only TRIANGLES: 0x0004 and TRIANGLE_STRIP: 0x0005 are supported\nfunction compressMesh(attributes, indices, mode = 4, options, context) {\n  if (!options.DracoWriter || !options.DracoLoader) {\n    throw new Error('DracoWriter/DracoLoader not available');\n  }\n\n  // TODO - use DracoWriter using encode w/ registered DracoWriter...\n  const compressedData = options.DracoWriter.encodeSync({attributes});\n\n  // Draco compression may change the order and number of vertices in a mesh.\n  // To satisfy the requirement that accessors properties be correct for both\n  // compressed and uncompressed data, generators should create uncompressed\n  // attributes and indices using data that has been decompressed from the Draco buffer,\n  // rather than the original source data.\n  const {parseSync} = context;\n  const decodedData = parseSync({attributes});\n  const fauxAccessors = options._addFauxAttributes(decodedData.attributes);\n\n  const bufferViewIndex = options.addBufferView(compressedData);\n\n  const glTFMesh = {\n    primitives: [\n      {\n        attributes: fauxAccessors, // TODO - verify with spec\n        mode, // GL.POINTS\n        extensions: {\n          [KHR_DRACO_MESH_COMPRESSION]: {\n            bufferView: bufferViewIndex,\n            attributes: fauxAccessors // TODO - verify with spec\n          }\n        }\n      }\n    ]\n  };\n\n  return glTFMesh;\n}\n\n// UTILS\n\nfunction checkPrimitive(primitive) {\n  if (!primitive.attributes && Object.keys(primitive.attributes).length > 0) {\n    throw new Error('Empty glTF primitive detected: Draco decompression failure?');\n  }\n}\n\nfunction* meshPrimitiveIterator(scenegraph) {\n  for (const mesh of scenegraph.json.meshes || []) {\n    for (const primitive of mesh.primitives) {\n      yield primitive;\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}