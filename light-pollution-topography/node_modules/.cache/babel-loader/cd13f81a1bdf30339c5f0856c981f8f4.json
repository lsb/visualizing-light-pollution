{"ast":null,"code":"// Licensed to the Apache Software Foundation (ASF) under one\n// or more contributor license agreements.  See the NOTICE file\n// distributed with this work for additional information\n// regarding copyright ownership.  The ASF licenses this file\n// to you under the Apache License, Version 2.0 (the\n// \"License\"); you may not use this file except in compliance\n// with the License.  You may obtain a copy of the License at\n//\n//   http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing,\n// software distributed under the License is distributed on an\n// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n// KIND, either express or implied.  See the License for the\n// specific language governing permissions and limitations\n// under the License.\n\n/* tslint:disable:class-name */\nimport * as File_ from '../../fb/File';\nimport { flatbuffers } from 'flatbuffers';\nvar Long = flatbuffers.Long;\nvar Builder = flatbuffers.Builder;\nvar ByteBuffer = flatbuffers.ByteBuffer;\nvar _Block = File_.org.apache.arrow.flatbuf.Block;\nvar _Footer = File_.org.apache.arrow.flatbuf.Footer;\nimport { Schema } from '../../schema';\nimport { MetadataVersion } from '../../enum';\nimport { toUint8Array } from '../../util/buffer';\n/** @ignore */\n\nclass Footer_ {\n  constructor(schema, version = MetadataVersion.V4, recordBatches, dictionaryBatches) {\n    this.schema = schema;\n    this.version = version;\n    recordBatches && (this._recordBatches = recordBatches);\n    dictionaryBatches && (this._dictionaryBatches = dictionaryBatches);\n  }\n  /** @nocollapse */\n\n\n  static decode(buf) {\n    buf = new ByteBuffer(toUint8Array(buf));\n\n    const footer = _Footer.getRootAsFooter(buf);\n\n    const schema = Schema.decode(footer.schema());\n    return new OffHeapFooter(schema, footer);\n  }\n  /** @nocollapse */\n\n\n  static encode(footer) {\n    const b = new Builder();\n    const schemaOffset = Schema.encode(b, footer.schema);\n\n    _Footer.startRecordBatchesVector(b, footer.numRecordBatches);\n\n    [...footer.recordBatches()].slice().reverse().forEach(rb => FileBlock.encode(b, rb));\n    const recordBatchesOffset = b.endVector();\n\n    _Footer.startDictionariesVector(b, footer.numDictionaries);\n\n    [...footer.dictionaryBatches()].slice().reverse().forEach(db => FileBlock.encode(b, db));\n    const dictionaryBatchesOffset = b.endVector();\n\n    _Footer.startFooter(b);\n\n    _Footer.addSchema(b, schemaOffset);\n\n    _Footer.addVersion(b, MetadataVersion.V4);\n\n    _Footer.addRecordBatches(b, recordBatchesOffset);\n\n    _Footer.addDictionaries(b, dictionaryBatchesOffset);\n\n    _Footer.finishFooterBuffer(b, _Footer.endFooter(b));\n\n    return b.asUint8Array();\n  }\n\n  get numRecordBatches() {\n    return this._recordBatches.length;\n  }\n\n  get numDictionaries() {\n    return this._dictionaryBatches.length;\n  }\n\n  *recordBatches() {\n    for (let block, i = -1, n = this.numRecordBatches; ++i < n;) {\n      if (block = this.getRecordBatch(i)) {\n        yield block;\n      }\n    }\n  }\n\n  *dictionaryBatches() {\n    for (let block, i = -1, n = this.numDictionaries; ++i < n;) {\n      if (block = this.getDictionaryBatch(i)) {\n        yield block;\n      }\n    }\n  }\n\n  getRecordBatch(index) {\n    return index >= 0 && index < this.numRecordBatches && this._recordBatches[index] || null;\n  }\n\n  getDictionaryBatch(index) {\n    return index >= 0 && index < this.numDictionaries && this._dictionaryBatches[index] || null;\n  }\n\n}\n\nexport { Footer_ as Footer };\n/** @ignore */\n\nclass OffHeapFooter extends Footer_ {\n  constructor(schema, _footer) {\n    super(schema, _footer.version());\n    this._footer = _footer;\n  }\n\n  get numRecordBatches() {\n    return this._footer.recordBatchesLength();\n  }\n\n  get numDictionaries() {\n    return this._footer.dictionariesLength();\n  }\n\n  getRecordBatch(index) {\n    if (index >= 0 && index < this.numRecordBatches) {\n      const fileBlock = this._footer.recordBatches(index);\n\n      if (fileBlock) {\n        return FileBlock.decode(fileBlock);\n      }\n    }\n\n    return null;\n  }\n\n  getDictionaryBatch(index) {\n    if (index >= 0 && index < this.numDictionaries) {\n      const fileBlock = this._footer.dictionaries(index);\n\n      if (fileBlock) {\n        return FileBlock.decode(fileBlock);\n      }\n    }\n\n    return null;\n  }\n\n}\n/** @ignore */\n\n\nexport class FileBlock {\n  /** @nocollapse */\n  static decode(block) {\n    return new FileBlock(block.metaDataLength(), block.bodyLength(), block.offset());\n  }\n  /** @nocollapse */\n\n\n  static encode(b, fileBlock) {\n    const {\n      metaDataLength\n    } = fileBlock;\n    const offset = new Long(fileBlock.offset, 0);\n    const bodyLength = new Long(fileBlock.bodyLength, 0);\n    return _Block.createBlock(b, offset, metaDataLength, bodyLength);\n  }\n\n  constructor(metaDataLength, bodyLength, offset) {\n    this.metaDataLength = metaDataLength;\n    this.offset = typeof offset === 'number' ? offset : offset.low;\n    this.bodyLength = typeof bodyLength === 'number' ? bodyLength : bodyLength.low;\n  }\n\n}","map":{"version":3,"sources":["ipc/metadata/file.ts"],"names":[],"mappings":"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","sourcesContent":["// Licensed to the Apache Software Foundation (ASF) under one\n// or more contributor license agreements.  See the NOTICE file\n// distributed with this work for additional information\n// regarding copyright ownership.  The ASF licenses this file\n// to you under the Apache License, Version 2.0 (the\n// \"License\"); you may not use this file except in compliance\n// with the License.  You may obtain a copy of the License at\n//\n//   http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing,\n// software distributed under the License is distributed on an\n// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n// KIND, either express or implied.  See the License for the\n// specific language governing permissions and limitations\n// under the License.\n\n/* tslint:disable:class-name */\n\nimport * as File_ from '../../fb/File';\nimport { flatbuffers } from 'flatbuffers';\n\nimport Long = flatbuffers.Long;\nimport Builder = flatbuffers.Builder;\nimport ByteBuffer = flatbuffers.ByteBuffer;\nimport _Block = File_.org.apache.arrow.flatbuf.Block;\nimport _Footer = File_.org.apache.arrow.flatbuf.Footer;\n\nimport { Schema } from '../../schema';\nimport { MetadataVersion } from '../../enum';\nimport { toUint8Array } from '../../util/buffer';\nimport { ArrayBufferViewInput } from '../../util/buffer';\n\n/** @ignore */\nclass Footer_ {\n\n    /** @nocollapse */\n    public static decode(buf: ArrayBufferViewInput) {\n        buf = new ByteBuffer(toUint8Array(buf));\n        const footer = _Footer.getRootAsFooter(buf);\n        const schema = Schema.decode(footer.schema()!);\n        return new OffHeapFooter(schema, footer) as Footer_;\n    }\n\n    /** @nocollapse */\n    public static encode(footer: Footer_) {\n\n        const b: Builder = new Builder();\n        const schemaOffset = Schema.encode(b, footer.schema);\n\n        _Footer.startRecordBatchesVector(b, footer.numRecordBatches);\n        [...footer.recordBatches()].slice().reverse().forEach((rb) => FileBlock.encode(b, rb));\n        const recordBatchesOffset = b.endVector();\n\n        _Footer.startDictionariesVector(b, footer.numDictionaries);\n        [...footer.dictionaryBatches()].slice().reverse().forEach((db) => FileBlock.encode(b, db));\n\n        const dictionaryBatchesOffset = b.endVector();\n\n        _Footer.startFooter(b);\n        _Footer.addSchema(b, schemaOffset);\n        _Footer.addVersion(b, MetadataVersion.V4);\n        _Footer.addRecordBatches(b, recordBatchesOffset);\n        _Footer.addDictionaries(b, dictionaryBatchesOffset);\n        _Footer.finishFooterBuffer(b, _Footer.endFooter(b));\n\n        return b.asUint8Array();\n    }\n\n    // @ts-ignore\n    protected _recordBatches: FileBlock[];\n    // @ts-ignore\n    protected _dictionaryBatches: FileBlock[];\n    public get numRecordBatches() { return this._recordBatches.length; }\n    public get numDictionaries() { return this._dictionaryBatches.length; }\n\n    constructor(public schema: Schema,\n                public version: MetadataVersion = MetadataVersion.V4,\n                recordBatches?: FileBlock[], dictionaryBatches?: FileBlock[]) {\n        recordBatches && (this._recordBatches = recordBatches);\n        dictionaryBatches && (this._dictionaryBatches = dictionaryBatches);\n    }\n\n    public *recordBatches(): Iterable<FileBlock> {\n        for (let block, i = -1, n = this.numRecordBatches; ++i < n;) {\n            if (block = this.getRecordBatch(i)) { yield block; }\n        }\n    }\n\n    public *dictionaryBatches(): Iterable<FileBlock> {\n        for (let block, i = -1, n = this.numDictionaries; ++i < n;) {\n            if (block = this.getDictionaryBatch(i)) { yield block; }\n        }\n    }\n\n    public getRecordBatch(index: number) {\n        return index >= 0\n            && index < this.numRecordBatches\n            && this._recordBatches[index] || null;\n    }\n\n    public getDictionaryBatch(index: number) {\n        return index >= 0\n            && index < this.numDictionaries\n            && this._dictionaryBatches[index] || null;\n    }\n}\n\nexport { Footer_ as Footer };\n\n/** @ignore */\nclass OffHeapFooter extends Footer_ {\n\n    public get numRecordBatches() { return this._footer.recordBatchesLength(); }\n    public get numDictionaries() { return this._footer.dictionariesLength(); }\n\n    constructor(schema: Schema, protected _footer: _Footer) {\n        super(schema, _footer.version());\n    }\n\n    public getRecordBatch(index: number) {\n        if (index >= 0 && index < this.numRecordBatches) {\n            const fileBlock = this._footer.recordBatches(index);\n            if (fileBlock) { return FileBlock.decode(fileBlock); }\n        }\n        return null;\n    }\n\n    public getDictionaryBatch(index: number) {\n        if (index >= 0 && index < this.numDictionaries) {\n            const fileBlock = this._footer.dictionaries(index);\n            if (fileBlock) { return FileBlock.decode(fileBlock); }\n        }\n        return null;\n    }\n}\n\n/** @ignore */\nexport class FileBlock {\n\n    /** @nocollapse */\n    public static decode(block: _Block) {\n        return new FileBlock(block.metaDataLength(), block.bodyLength(), block.offset());\n    }\n\n    /** @nocollapse */\n    public static encode(b: Builder, fileBlock: FileBlock) {\n        const { metaDataLength } = fileBlock;\n        const offset = new Long(fileBlock.offset, 0);\n        const bodyLength = new Long(fileBlock.bodyLength, 0);\n        return _Block.createBlock(b, offset, metaDataLength, bodyLength);\n    }\n\n    public offset: number;\n    public bodyLength: number;\n    public metaDataLength: number;\n\n    constructor(metaDataLength: number, bodyLength: Long | number, offset: Long | number) {\n        this.metaDataLength = metaDataLength;\n        this.offset = typeof offset === 'number' ? offset : offset.low;\n        this.bodyLength = typeof bodyLength === 'number' ? bodyLength : bodyLength.low;\n    }\n}\n"]},"metadata":{},"sourceType":"module"}