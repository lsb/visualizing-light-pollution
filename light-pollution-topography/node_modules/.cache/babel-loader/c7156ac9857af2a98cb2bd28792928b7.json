{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _get from \"@babel/runtime/helpers/esm/get\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport Resource from './resource';\nimport Buffer from './buffer';\nimport { isWebGL2 } from '@luma.gl/gltools';\nimport { getScratchArray, fillArray } from '../utils/array-utils-flat';\nimport { assert } from '../utils';\nimport { getBrowser } from 'probe.gl';\nvar ERR_ELEMENTS = 'elements must be GL.ELEMENT_ARRAY_BUFFER';\n\nvar VertexArrayObject = function (_Resource) {\n  _inherits(VertexArrayObject, _Resource);\n\n  _createClass(VertexArrayObject, null, [{\n    key: \"isSupported\",\n    value: function isSupported(gl) {\n      var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n      if (options.constantAttributeZero) {\n        return isWebGL2(gl) || getBrowser() === 'Chrome';\n      }\n\n      return true;\n    }\n  }, {\n    key: \"getDefaultArray\",\n    value: function getDefaultArray(gl) {\n      gl.luma = gl.luma || {};\n\n      if (!gl.luma.defaultVertexArray) {\n        gl.luma.defaultVertexArray = new VertexArrayObject(gl, {\n          handle: null,\n          isDefaultArray: true\n        });\n      }\n\n      return gl.luma.defaultVertexArray;\n    }\n  }, {\n    key: \"getMaxAttributes\",\n    value: function getMaxAttributes(gl) {\n      VertexArrayObject.MAX_ATTRIBUTES = VertexArrayObject.MAX_ATTRIBUTES || gl.getParameter(34921);\n      return VertexArrayObject.MAX_ATTRIBUTES;\n    }\n  }, {\n    key: \"setConstant\",\n    value: function setConstant(gl, location, array) {\n      switch (array.constructor) {\n        case Float32Array:\n          VertexArrayObject._setConstantFloatArray(gl, location, array);\n\n          break;\n\n        case Int32Array:\n          VertexArrayObject._setConstantIntArray(gl, location, array);\n\n          break;\n\n        case Uint32Array:\n          VertexArrayObject._setConstantUintArray(gl, location, array);\n\n          break;\n\n        default:\n          assert(false);\n      }\n    }\n  }]);\n\n  function VertexArrayObject(gl) {\n    var _this;\n\n    var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    _classCallCheck(this, VertexArrayObject);\n\n    var id = opts.id || opts.program && opts.program.id;\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(VertexArrayObject).call(this, gl, Object.assign({}, opts, {\n      id: id\n    })));\n    _this.buffer = null;\n    _this.bufferValue = null;\n    _this.isDefaultArray = opts.isDefaultArray || false;\n\n    _this.initialize(opts);\n\n    Object.seal(_assertThisInitialized(_this));\n    return _this;\n  }\n\n  _createClass(VertexArrayObject, [{\n    key: \"delete\",\n    value: function _delete() {\n      _get(_getPrototypeOf(VertexArrayObject.prototype), \"delete\", this).call(this);\n\n      if (this.buffer) {\n        this.buffer[\"delete\"]();\n      }\n    }\n  }, {\n    key: \"initialize\",\n    value: function initialize() {\n      var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      return this.setProps(props);\n    }\n  }, {\n    key: \"setProps\",\n    value: function setProps(props) {\n      return this;\n    }\n  }, {\n    key: \"setElementBuffer\",\n    value: function setElementBuffer() {\n      var _this2 = this;\n\n      var elementBuffer = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;\n      var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n      assert(!elementBuffer || elementBuffer.target === 34963, ERR_ELEMENTS);\n      this.bind(function () {\n        _this2.gl.bindBuffer(34963, elementBuffer ? elementBuffer.handle : null);\n      });\n      return this;\n    }\n  }, {\n    key: \"setBuffer\",\n    value: function setBuffer(location, buffer, accessor) {\n      if (buffer.target === 34963) {\n        return this.setElementBuffer(buffer, accessor);\n      }\n\n      var size = accessor.size,\n          type = accessor.type,\n          stride = accessor.stride,\n          offset = accessor.offset,\n          normalized = accessor.normalized,\n          integer = accessor.integer,\n          divisor = accessor.divisor;\n      var gl = this.gl;\n      location = Number(location);\n      this.bind(function () {\n        gl.bindBuffer(34962, buffer.handle);\n\n        if (integer) {\n          assert(isWebGL2(gl));\n          gl.vertexAttribIPointer(location, size, type, stride, offset);\n        } else {\n          gl.vertexAttribPointer(location, size, type, normalized, stride, offset);\n        }\n\n        gl.enableVertexAttribArray(location);\n        gl.vertexAttribDivisor(location, divisor || 0);\n      });\n      return this;\n    }\n  }, {\n    key: \"enable\",\n    value: function enable(location) {\n      var _this3 = this;\n\n      var _enable = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n\n      var disablingAttributeZero = !_enable && location === 0 && !VertexArrayObject.isSupported(this.gl, {\n        constantAttributeZero: true\n      });\n\n      if (!disablingAttributeZero) {\n        location = Number(location);\n        this.bind(function () {\n          return _enable ? _this3.gl.enableVertexAttribArray(location) : _this3.gl.disableVertexAttribArray(location);\n        });\n      }\n\n      return this;\n    }\n  }, {\n    key: \"getConstantBuffer\",\n    value: function getConstantBuffer(elementCount, value, accessor) {\n      var constantValue = this._normalizeConstantArrayValue(value, accessor);\n\n      var byteLength = constantValue.byteLength * elementCount;\n      var length = constantValue.length * elementCount;\n      var updateNeeded = !this.buffer;\n      this.buffer = this.buffer || new Buffer(this.gl, byteLength);\n      updateNeeded = updateNeeded || this.buffer.reallocate(byteLength);\n      updateNeeded = updateNeeded || !this._compareConstantArrayValues(constantValue, this.bufferValue);\n\n      if (updateNeeded) {\n        var typedArray = getScratchArray(value.constructor, length);\n        fillArray({\n          target: typedArray,\n          source: constantValue,\n          start: 0,\n          count: length\n        });\n        this.buffer.subData(typedArray);\n        this.bufferValue = value;\n      }\n\n      return this.buffer;\n    }\n  }, {\n    key: \"_normalizeConstantArrayValue\",\n    value: function _normalizeConstantArrayValue(arrayValue, accessor) {\n      if (Array.isArray(arrayValue)) {\n        return new Float32Array(arrayValue);\n      }\n\n      return arrayValue;\n    }\n  }, {\n    key: \"_compareConstantArrayValues\",\n    value: function _compareConstantArrayValues(v1, v2) {\n      if (!v1 || !v2 || v1.length !== v2.length || v1.constructor !== v2.constructor) {\n        return false;\n      }\n\n      for (var i = 0; i < v1.length; ++i) {\n        if (v1[i] !== v2[i]) {\n          return false;\n        }\n      }\n\n      return true;\n    }\n  }, {\n    key: \"_createHandle\",\n    value: function _createHandle() {\n      return this.gl.createVertexArray();\n    }\n  }, {\n    key: \"_deleteHandle\",\n    value: function _deleteHandle(handle) {\n      this.gl.deleteVertexArray(handle);\n      return [this.elements];\n    }\n  }, {\n    key: \"_bindHandle\",\n    value: function _bindHandle(handle) {\n      this.gl.bindVertexArray(handle);\n    }\n  }, {\n    key: \"_getParameter\",\n    value: function _getParameter(pname, _ref) {\n      var _this4 = this;\n\n      var location = _ref.location;\n      assert(Number.isFinite(location));\n      return this.bind(function () {\n        switch (pname) {\n          case 34373:\n            return _this4.gl.getVertexAttribOffset(location, pname);\n\n          default:\n            return _this4.gl.getVertexAttrib(location, pname);\n        }\n      });\n    }\n  }, {\n    key: \"MAX_ATTRIBUTES\",\n    get: function get() {\n      return VertexArrayObject.getMaxAttributes(this.gl);\n    }\n  }], [{\n    key: \"_setConstantFloatArray\",\n    value: function _setConstantFloatArray(gl, location, array) {\n      switch (array.length) {\n        case 1:\n          gl.vertexAttrib1fv(location, array);\n          break;\n\n        case 2:\n          gl.vertexAttrib2fv(location, array);\n          break;\n\n        case 3:\n          gl.vertexAttrib3fv(location, array);\n          break;\n\n        case 4:\n          gl.vertexAttrib4fv(location, array);\n          break;\n\n        default:\n          assert(false);\n      }\n    }\n  }, {\n    key: \"_setConstantIntArray\",\n    value: function _setConstantIntArray(gl, location, array) {\n      assert(isWebGL2(gl));\n\n      switch (array.length) {\n        case 1:\n          gl.vertexAttribI1iv(location, array);\n          break;\n\n        case 2:\n          gl.vertexAttribI2iv(location, array);\n          break;\n\n        case 3:\n          gl.vertexAttribI3iv(location, array);\n          break;\n\n        case 4:\n          gl.vertexAttribI4iv(location, array);\n          break;\n\n        default:\n          assert(false);\n      }\n    }\n  }, {\n    key: \"_setConstantUintArray\",\n    value: function _setConstantUintArray(gl, location, array) {\n      assert(isWebGL2(gl));\n\n      switch (array.length) {\n        case 1:\n          gl.vertexAttribI1uiv(location, array);\n          break;\n\n        case 2:\n          gl.vertexAttribI2uiv(location, array);\n          break;\n\n        case 3:\n          gl.vertexAttribI3uiv(location, array);\n          break;\n\n        case 4:\n          gl.vertexAttribI4uiv(location, array);\n          break;\n\n        default:\n          assert(false);\n      }\n    }\n  }]);\n\n  return VertexArrayObject;\n}(Resource);\n\nexport { VertexArrayObject as default };","map":{"version":3,"sources":["../../../src/classes/vertex-array-object.js"],"names":["ERR_ELEMENTS","VertexArrayObject","Resource","gl","options","isWebGL2","getBrowser","handle","isDefaultArray","location","array","assert","opts","id","Object","props","elementBuffer","buffer","accessor","size","type","stride","offset","normalized","integer","divisor","Number","enable","disablingAttributeZero","constantAttributeZero","elementCount","value","constantValue","byteLength","length","updateNeeded","typedArray","getScratchArray","fillArray","target","source","start","count","arrayValue","Array","v1","v2","i","pname"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants';\nimport Resource from './resource';\nimport Buffer from './buffer';\nimport {isWebGL2} from '@luma.gl/gltools';\nimport {getScratchArray, fillArray} from '../utils/array-utils-flat';\nimport {assert} from '../utils';\nimport {getBrowser} from 'probe.gl';\n\nconst ERR_ELEMENTS = 'elements must be GL.ELEMENT_ARRAY_BUFFER';\n\nexport default class VertexArrayObject extends Resource {\n  static isSupported(gl, options = {}) {\n    // Attribute 0 can not be disable on most desktop OpenGL based browsers\n    // and on iOS Safari browser.\n    if (options.constantAttributeZero) {\n      return isWebGL2(gl) || getBrowser() === 'Chrome';\n    }\n\n    // Whether additional objects can be created\n    return true;\n  }\n\n  // Returns the global (null) vertex array object. Exists even when no extension available\n  // TODO(Tarek): VAOs are now polyfilled. Deprecate this in 9.0\n  static getDefaultArray(gl) {\n    gl.luma = gl.luma || {};\n    if (!gl.luma.defaultVertexArray) {\n      gl.luma.defaultVertexArray = new VertexArrayObject(gl, {handle: null, isDefaultArray: true});\n    }\n    return gl.luma.defaultVertexArray;\n  }\n\n  static getMaxAttributes(gl) {\n    // TODO - should be cached per context\n    VertexArrayObject.MAX_ATTRIBUTES =\n      VertexArrayObject.MAX_ATTRIBUTES || gl.getParameter(gl.MAX_VERTEX_ATTRIBS);\n    return VertexArrayObject.MAX_ATTRIBUTES;\n  }\n\n  // Note: Constants are stored globally on the WebGL context, not the VAO\n  // So they need to be updated before every render\n  // TODO - use known type (in configuration or passed in) to allow non-typed arrays?\n  // TODO - remember/cache values to avoid setting them unnecessarily?\n  static setConstant(gl, location, array) {\n    switch (array.constructor) {\n      case Float32Array:\n        VertexArrayObject._setConstantFloatArray(gl, location, array);\n        break;\n      case Int32Array:\n        VertexArrayObject._setConstantIntArray(gl, location, array);\n        break;\n      case Uint32Array:\n        VertexArrayObject._setConstantUintArray(gl, location, array);\n        break;\n      default:\n        assert(false);\n    }\n  }\n\n  // Create a VertexArray\n  constructor(gl, opts = {}) {\n    // Use program's id if program but no id is supplied\n    const id = opts.id || (opts.program && opts.program.id);\n    super(gl, Object.assign({}, opts, {id}));\n\n    this.buffer = null;\n    this.bufferValue = null;\n    this.isDefaultArray = opts.isDefaultArray || false;\n\n    this.initialize(opts);\n\n    Object.seal(this);\n  }\n\n  delete() {\n    super.delete();\n    if (this.buffer) {\n      this.buffer.delete();\n    }\n  }\n\n  get MAX_ATTRIBUTES() {\n    return VertexArrayObject.getMaxAttributes(this.gl);\n  }\n\n  initialize(props = {}) {\n    return this.setProps(props);\n  }\n\n  setProps(props) {\n    // TODO: decide which props should be supported\n    return this;\n  }\n\n  // Set (bind) an elements buffer, for indexed rendering.\n  // Must be a Buffer bound to GL.ELEMENT_ARRAY_BUFFER. Constants not supported\n  setElementBuffer(elementBuffer = null, opts = {}) {\n    assert(!elementBuffer || elementBuffer.target === GL.ELEMENT_ARRAY_BUFFER, ERR_ELEMENTS);\n\n    // The GL.ELEMENT_ARRAY_BUFFER_BINDING is stored on the VertexArrayObject...\n    this.bind(() => {\n      this.gl.bindBuffer(GL.ELEMENT_ARRAY_BUFFER, elementBuffer ? elementBuffer.handle : null);\n    });\n\n    return this;\n  }\n\n  // Set a location in vertex attributes array to a bufferk, enables the location, sets divisor\n  setBuffer(location, buffer, accessor) {\n    // Check target\n    if (buffer.target === GL.ELEMENT_ARRAY_BUFFER) {\n      return this.setElementBuffer(buffer, accessor);\n    }\n\n    const {size, type, stride, offset, normalized, integer, divisor} = accessor;\n\n    const {gl} = this;\n    location = Number(location);\n\n    this.bind(() => {\n      // A non-zero buffer object must be bound to the GL_ARRAY_BUFFER target\n      gl.bindBuffer(gl.ARRAY_BUFFER, buffer.handle);\n\n      // WebGL2 supports *integer* data formats, i.e. GPU will see integer values\n      if (integer) {\n        assert(isWebGL2(gl));\n        gl.vertexAttribIPointer(location, size, type, stride, offset);\n      } else {\n        // Attaches ARRAY_BUFFER with specified buffer format to location\n        gl.vertexAttribPointer(location, size, type, normalized, stride, offset);\n      }\n      gl.enableVertexAttribArray(location);\n      gl.vertexAttribDivisor(location, divisor || 0);\n\n      // NOTE We don't unbind buffer here, typically another buffer will be bound just after\n    });\n\n    return this;\n  }\n\n  // Enabling an attribute location makes it reference the currently bound buffer\n  // Disabling an attribute location makes it reference the global constant value\n  // TODO - handle single values for size 1 attributes?\n  // TODO - convert classic arrays based on known type?\n  enable(location, enable = true) {\n    // Attribute 0 cannot be disabled in most desktop OpenGL based browsers\n    const disablingAttributeZero =\n      !enable &&\n      location === 0 &&\n      !VertexArrayObject.isSupported(this.gl, {constantAttributeZero: true});\n\n    if (!disablingAttributeZero) {\n      location = Number(location);\n      this.bind(\n        () =>\n          enable\n            ? this.gl.enableVertexAttribArray(location)\n            : this.gl.disableVertexAttribArray(location)\n      );\n    }\n    return this;\n  }\n\n  // Provide a means to create a buffer that is equivalent to a constant.\n  // NOTE: Desktop OpenGL cannot disable attribute 0.\n  // https://stackoverflow.com/questions/20305231/webgl-warning-attribute-0-is-disabled-\n  // this-has-significant-performance-penalt\n  getConstantBuffer(elementCount, value, accessor) {\n    // Create buffer only when needed, and reuse it (avoids inflating buffer creation statistics)\n\n    const constantValue = this._normalizeConstantArrayValue(value, accessor);\n\n    const byteLength = constantValue.byteLength * elementCount;\n    const length = constantValue.length * elementCount;\n\n    let updateNeeded = !this.buffer;\n\n    this.buffer = this.buffer || new Buffer(this.gl, byteLength);\n    updateNeeded = updateNeeded || this.buffer.reallocate(byteLength);\n\n    // Reallocate and update contents if needed\n    updateNeeded =\n      updateNeeded || !this._compareConstantArrayValues(constantValue, this.bufferValue);\n\n    if (updateNeeded) {\n      // Create a typed array that is big enough, and fill it with the required data\n      const typedArray = getScratchArray(value.constructor, length);\n      fillArray({target: typedArray, source: constantValue, start: 0, count: length});\n      this.buffer.subData(typedArray);\n      this.bufferValue = value;\n    }\n\n    return this.buffer;\n  }\n\n  // PRIVATE\n\n  // TODO - convert Arrays based on known type? (read type from accessor, don't assume Float32Array)\n  // TODO - handle single values for size 1 attributes?\n  _normalizeConstantArrayValue(arrayValue, accessor) {\n    if (Array.isArray(arrayValue)) {\n      return new Float32Array(arrayValue);\n    }\n    return arrayValue;\n  }\n\n  _compareConstantArrayValues(v1, v2) {\n    if (!v1 || !v2 || v1.length !== v2.length || v1.constructor !== v2.constructor) {\n      return false;\n    }\n    for (let i = 0; i < v1.length; ++i) {\n      if (v1[i] !== v2[i]) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  static _setConstantFloatArray(gl, location, array) {\n    switch (array.length) {\n      case 1:\n        gl.vertexAttrib1fv(location, array);\n        break;\n      case 2:\n        gl.vertexAttrib2fv(location, array);\n        break;\n      case 3:\n        gl.vertexAttrib3fv(location, array);\n        break;\n      case 4:\n        gl.vertexAttrib4fv(location, array);\n        break;\n      default:\n        assert(false);\n    }\n  }\n\n  static _setConstantIntArray(gl, location, array) {\n    assert(isWebGL2(gl));\n    switch (array.length) {\n      case 1:\n        gl.vertexAttribI1iv(location, array);\n        break;\n      case 2:\n        gl.vertexAttribI2iv(location, array);\n        break;\n      case 3:\n        gl.vertexAttribI3iv(location, array);\n        break;\n      case 4:\n        gl.vertexAttribI4iv(location, array);\n        break;\n      default:\n        assert(false);\n    }\n  }\n\n  static _setConstantUintArray(gl, location, array) {\n    assert(isWebGL2(gl));\n    switch (array.length) {\n      case 1:\n        gl.vertexAttribI1uiv(location, array);\n        break;\n      case 2:\n        gl.vertexAttribI2uiv(location, array);\n        break;\n      case 3:\n        gl.vertexAttribI3uiv(location, array);\n        break;\n      case 4:\n        gl.vertexAttribI4uiv(location, array);\n        break;\n      default:\n        assert(false);\n    }\n  }\n\n  // RESOURCE IMPLEMENTATION\n\n  _createHandle() {\n    return this.gl.createVertexArray();\n  }\n\n  _deleteHandle(handle) {\n    this.gl.deleteVertexArray(handle);\n    return [this.elements];\n    // return [this.elements, ...this.buffers];\n  }\n\n  _bindHandle(handle) {\n    this.gl.bindVertexArray(handle);\n  }\n\n  // Generic getter for information about a vertex attribute at a given position\n  _getParameter(pname, {location}) {\n    assert(Number.isFinite(location));\n    return this.bind(() => {\n      switch (pname) {\n        case GL.VERTEX_ATTRIB_ARRAY_POINTER:\n          return this.gl.getVertexAttribOffset(location, pname);\n        default:\n          return this.gl.getVertexAttrib(location, pname);\n      }\n    });\n  }\n}\n"]},"metadata":{},"sourceType":"module"}