{"version":3,"sources":["../../../src/tile-layer/tile-layer.js"],"names":["CompositeLayer","_flatten","flatten","GeoJsonLayer","Tileset2D","STRATEGY_DEFAULT","urlType","getURLFromTemplate","defaultProps","data","dataComparator","equals","renderSubLayers","type","value","props","compare","getTileData","optional","onViewportLoad","onTileLoad","tile","onTileError","err","console","error","tileSize","maxZoom","minZoom","maxCacheSize","maxCacheByteSize","refinementStrategy","TileLayer","initializeState","state","tiles","isLoaded","tileset","selectedTiles","every","layers","layer","shouldUpdateState","changeFlags","somethingChanged","updateState","oldProps","context","createTileCache","dataChanged","updateTriggersChanged","all","bind","_onTileLoad","_onTileError","setState","propsChanged","setOptions","forEach","viewportChanged","_updateTileset","frameNumber","update","viewport","loadingStateChanged","tilesetChanged","map","getCurrentLayer","fetch","url","getPickingInfo","info","sourceLayer","renderLayers","visible","isVisible","Object","assign","id","x","y","z","_offset","Boolean","clone","layerName"],"mappings":"AAAA,SAAQA,cAAR,EAAwBC,QAAQ,IAAIC,OAApC,QAAkD,eAAlD;AACA,SAAQC,YAAR,QAA2B,iBAA3B;AAEA,OAAOC,SAAP,IAAmBC,gBAAnB,QAA0C,cAA1C;AACA,SAAQC,OAAR,EAAiBC,kBAAjB,QAA0C,SAA1C;AAEA,MAAMC,YAAY,GAAG;AACnBC,EAAAA,IAAI,EAAE,EADa;AAEnBC,EAAAA,cAAc,EAAEJ,OAAO,CAACK,MAFL;AAGnBC,EAAAA,eAAe,EAAE;AAACC,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAEC,KAAK,IAAI,IAAIZ,YAAJ,CAAiBY,KAAjB,CAAnC;AAA4DC,IAAAA,OAAO,EAAE;AAArE,GAHE;AAInBC,EAAAA,WAAW,EAAE;AAACJ,IAAAA,IAAI,EAAE,UAAP;AAAmBK,IAAAA,QAAQ,EAAE,IAA7B;AAAmCJ,IAAAA,KAAK,EAAE,IAA1C;AAAgDE,IAAAA,OAAO,EAAE;AAAzD,GAJM;AAMnBG,EAAAA,cAAc,EAAE;AAACN,IAAAA,IAAI,EAAE,UAAP;AAAmBK,IAAAA,QAAQ,EAAE,IAA7B;AAAmCJ,IAAAA,KAAK,EAAE,IAA1C;AAAgDE,IAAAA,OAAO,EAAE;AAAzD,GANG;AAOnBI,EAAAA,UAAU,EAAE;AAACP,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAEO,IAAI,IAAI,CAAE,CAApC;AAAsCL,IAAAA,OAAO,EAAE;AAA/C,GAPO;AASnBM,EAAAA,WAAW,EAAE;AAACT,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAES,GAAG,IAAIC,OAAO,CAACC,KAAR,CAAcF,GAAd,CAAjC;AAAqDP,IAAAA,OAAO,EAAE;AAA9D,GATM;AAUnBU,EAAAA,QAAQ,EAAE,GAVS;AAWnBC,EAAAA,OAAO,EAAE,IAXU;AAYnBC,EAAAA,OAAO,EAAE,CAZU;AAanBC,EAAAA,YAAY,EAAE,IAbK;AAcnBC,EAAAA,gBAAgB,EAAE,IAdC;AAenBC,EAAAA,kBAAkB,EAAE1B;AAfD,CAArB;AAkBA,eAAe,MAAM2B,SAAN,SAAwBhC,cAAxB,CAAuC;AACpDiC,EAAAA,eAAe,GAAG;AAChB,SAAKC,KAAL,GAAa;AACXC,MAAAA,KAAK,EAAE,EADI;AAEXC,MAAAA,QAAQ,EAAE;AAFC,KAAb;AAID;;AAED,MAAIA,QAAJ,GAAe;AACb,UAAM;AAACC,MAAAA;AAAD,QAAY,KAAKH,KAAvB;AACA,WAAOG,OAAO,CAACC,aAAR,CAAsBC,KAAtB,CACLlB,IAAI,IAAIA,IAAI,CAACmB,MAAL,IAAenB,IAAI,CAACmB,MAAL,CAAYD,KAAZ,CAAkBE,KAAK,IAAIA,KAAK,CAACL,QAAjC,CADlB,CAAP;AAGD;;AAEDM,EAAAA,iBAAiB,CAAC;AAACC,IAAAA;AAAD,GAAD,EAAgB;AAC/B,WAAOA,WAAW,CAACC,gBAAnB;AACD;;AAEDC,EAAAA,WAAW,CAAC;AAAC9B,IAAAA,KAAD;AAAQ+B,IAAAA,QAAR;AAAkBC,IAAAA,OAAlB;AAA2BJ,IAAAA;AAA3B,GAAD,EAA0C;AACnD,QAAI;AAACN,MAAAA;AAAD,QAAY,KAAKH,KAArB;AACA,UAAMc,eAAe,GACnB,CAACX,OAAD,IACAM,WAAW,CAACM,WADZ,IAECN,WAAW,CAACO,qBAAZ,KACEP,WAAW,CAACO,qBAAZ,CAAkCC,GAAlC,IAAyCR,WAAW,CAACO,qBAAZ,CAAkCjC,WAD7E,CAHH;;AAMA,QAAI+B,eAAJ,EAAqB;AACnB,YAAM;AACJrB,QAAAA,OADI;AAEJC,QAAAA,OAFI;AAGJF,QAAAA,QAHI;AAIJG,QAAAA,YAJI;AAKJC,QAAAA,gBALI;AAMJC,QAAAA;AANI,UAOFhB,KAPJ;AAQAsB,MAAAA,OAAO,GAAG,IAAIjC,SAAJ,CAAc;AACtBa,QAAAA,WAAW,EAAE,KAAKA,WAAL,CAAiBmC,IAAjB,CAAsB,IAAtB,CADS;AAEtBvB,QAAAA,YAFsB;AAGtBC,QAAAA,gBAHsB;AAItBH,QAAAA,OAJsB;AAKtBC,QAAAA,OALsB;AAMtBF,QAAAA,QANsB;AAOtBK,QAAAA,kBAPsB;AAQtBX,QAAAA,UAAU,EAAE,KAAKiC,WAAL,CAAiBD,IAAjB,CAAsB,IAAtB,CARU;AAStB9B,QAAAA,WAAW,EAAE,KAAKgC,YAAL,CAAkBF,IAAlB,CAAuB,IAAvB;AATS,OAAd,CAAV;AAWA,WAAKG,QAAL,CAAc;AAAClB,QAAAA;AAAD,OAAd;AACD,KArBD,MAqBO,IAAIM,WAAW,CAACa,YAAhB,EAA8B;AACnCnB,MAAAA,OAAO,CAACoB,UAAR,CAAmB1C,KAAnB;AAEA,WAAKmB,KAAL,CAAWG,OAAX,CAAmBF,KAAnB,CAAyBuB,OAAzB,CAAiCrC,IAAI,IAAI;AACvCA,QAAAA,IAAI,CAACmB,MAAL,GAAc,IAAd;AACD,OAFD;AAGD;;AAED,QAAIQ,eAAe,IAAIL,WAAW,CAACgB,eAAnC,EAAoD;AAClD,WAAKC,cAAL;AACD;AACF;;AAEDA,EAAAA,cAAc,GAAG;AACf,UAAM;AAACvB,MAAAA;AAAD,QAAY,KAAKH,KAAvB;AACA,UAAM;AAACf,MAAAA;AAAD,QAAmB,KAAKJ,KAA9B;AACA,UAAM8C,WAAW,GAAGxB,OAAO,CAACyB,MAAR,CAAe,KAAKf,OAAL,CAAagB,QAA5B,CAApB;AACA,UAAM;AAAC3B,MAAAA;AAAD,QAAaC,OAAnB;AAEA,UAAM2B,mBAAmB,GAAG,KAAK9B,KAAL,CAAWE,QAAX,KAAwBA,QAApD;AACA,UAAM6B,cAAc,GAAG,KAAK/B,KAAL,CAAW2B,WAAX,KAA2BA,WAAlD;;AAEA,QAAIzB,QAAQ,IAAIjB,cAAZ,KAA+B6C,mBAAmB,IAAIC,cAAtD,CAAJ,EAA2E;AACzE9C,MAAAA,cAAc,CAACkB,OAAO,CAACC,aAAR,CAAsB4B,GAAtB,CAA0B7C,IAAI,IAAIA,IAAI,CAACZ,IAAvC,CAAD,CAAd;AACD;;AAED,QAAIwD,cAAJ,EAAoB;AAElB,WAAKV,QAAL,CAAc;AAACM,QAAAA;AAAD,OAAd;AACD;;AAED,SAAK3B,KAAL,CAAWE,QAAX,GAAsBA,QAAtB;AACD;;AAEDiB,EAAAA,WAAW,CAAChC,IAAD,EAAO;AAChB,UAAMoB,KAAK,GAAG,KAAK0B,eAAL,EAAd;AACA1B,IAAAA,KAAK,CAAC1B,KAAN,CAAYK,UAAZ,CAAuBC,IAAvB;;AACAoB,IAAAA,KAAK,CAACmB,cAAN;AACD;;AAEDN,EAAAA,YAAY,CAAC7B,KAAD,EAAQ;AAClB,UAAMgB,KAAK,GAAG,KAAK0B,eAAL,EAAd;AACA1B,IAAAA,KAAK,CAAC1B,KAAN,CAAYO,WAAZ,CAAwBG,KAAxB;;AAEAgB,IAAAA,KAAK,CAACmB,cAAN;AACD;;AAID3C,EAAAA,WAAW,CAACI,IAAD,EAAO;AAChB,UAAM;AAACJ,MAAAA,WAAD;AAAcmD,MAAAA,KAAd;AAAqB3D,MAAAA;AAArB,QAA6B,KAAKM,KAAxC;AAEAM,IAAAA,IAAI,CAACgD,GAAL,GAAW9D,kBAAkB,CAACE,IAAD,EAAOY,IAAP,CAA7B;;AAEA,QAAIJ,WAAJ,EAAiB;AACf,aAAOA,WAAW,CAACI,IAAD,CAAlB;AACD;;AACD,QAAIA,IAAI,CAACgD,GAAT,EAAc;AACZ,aAAOD,KAAK,CAAC/C,IAAI,CAACgD,GAAN,EAAW;AAAC5B,QAAAA,KAAK,EAAE;AAAR,OAAX,CAAZ;AACD;;AACD,WAAO,IAAP;AACD;;AAED7B,EAAAA,eAAe,CAACG,KAAD,EAAQ;AACrB,WAAO,KAAKA,KAAL,CAAWH,eAAX,CAA2BG,KAA3B,CAAP;AACD;;AAEDuD,EAAAA,cAAc,CAAC;AAACC,IAAAA,IAAD;AAAOC,IAAAA;AAAP,GAAD,EAAsB;AAClCD,IAAAA,IAAI,CAACC,WAAL,GAAmBA,WAAnB;AACAD,IAAAA,IAAI,CAAClD,IAAL,GAAYmD,WAAW,CAACzD,KAAZ,CAAkBM,IAA9B;AACA,WAAOkD,IAAP;AACD;;AAEDE,EAAAA,YAAY,GAAG;AACb,UAAM;AAACC,MAAAA;AAAD,QAAY,KAAK3D,KAAvB;AACA,WAAO,KAAKmB,KAAL,CAAWG,OAAX,CAAmBF,KAAnB,CAAyB+B,GAAzB,CAA6B7C,IAAI,IAAI;AAI1C,YAAMsD,SAAS,GAAGD,OAAO,IAAIrD,IAAI,CAACsD,SAAlC;;AAEA,UAAI,CAACtD,IAAI,CAACmB,MAAV,EAAkB;AAChB,cAAMA,MAAM,GAAG,KAAK5B,eAAL,CACbgE,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,KAAK9D,KAAvB,EAA8B;AAC5B+D,UAAAA,EAAE,YAAK,KAAKA,EAAV,cAAgBzD,IAAI,CAAC0D,CAArB,cAA0B1D,IAAI,CAAC2D,CAA/B,cAAoC3D,IAAI,CAAC4D,CAAzC,CAD0B;AAE5BxE,UAAAA,IAAI,EAAEY,IAAI,CAACZ,IAFiB;AAG5BiE,UAAAA,OAAO,EAAEC,SAHmB;AAI5BO,UAAAA,OAAO,EAAE,CAJmB;AAK5B7D,UAAAA;AAL4B,SAA9B,CADa,CAAf;AASAA,QAAAA,IAAI,CAACmB,MAAL,GAActC,OAAO,CAACsC,MAAD,EAAS2C,OAAT,CAArB;AACD,OAXD,MAWO,IAAI9D,IAAI,CAACmB,MAAL,CAAY,CAAZ,KAAkBnB,IAAI,CAACmB,MAAL,CAAY,CAAZ,EAAezB,KAAf,CAAqB2D,OAArB,KAAiCC,SAAvD,EAAkE;AACvEtD,QAAAA,IAAI,CAACmB,MAAL,GAAcnB,IAAI,CAACmB,MAAL,CAAY0B,GAAZ,CAAgBzB,KAAK,IAAIA,KAAK,CAAC2C,KAAN,CAAY;AAACV,UAAAA,OAAO,EAAEC;AAAV,SAAZ,CAAzB,CAAd;AACD;;AACD,aAAOtD,IAAI,CAACmB,MAAZ;AACD,KArBM,CAAP;AAsBD;;AAjJmD;AAoJtDR,SAAS,CAACqD,SAAV,GAAsB,WAAtB;AACArD,SAAS,CAACxB,YAAV,GAAyBA,YAAzB","sourcesContent":["import {CompositeLayer, _flatten as flatten} from '@deck.gl/core';\nimport {GeoJsonLayer} from '@deck.gl/layers';\n\nimport Tileset2D, {STRATEGY_DEFAULT} from './tileset-2d';\nimport {urlType, getURLFromTemplate} from './utils';\n\nconst defaultProps = {\n  data: [],\n  dataComparator: urlType.equals,\n  renderSubLayers: {type: 'function', value: props => new GeoJsonLayer(props), compare: false},\n  getTileData: {type: 'function', optional: true, value: null, compare: false},\n  // TODO - change to onViewportLoad to align with Tile3DLayer\n  onViewportLoad: {type: 'function', optional: true, value: null, compare: false},\n  onTileLoad: {type: 'function', value: tile => {}, compare: false},\n  // eslint-disable-next-line\n  onTileError: {type: 'function', value: err => console.error(err), compare: false},\n  tileSize: 512,\n  maxZoom: null,\n  minZoom: 0,\n  maxCacheSize: null,\n  maxCacheByteSize: null,\n  refinementStrategy: STRATEGY_DEFAULT\n};\n\nexport default class TileLayer extends CompositeLayer {\n  initializeState() {\n    this.state = {\n      tiles: [],\n      isLoaded: false\n    };\n  }\n\n  get isLoaded() {\n    const {tileset} = this.state;\n    return tileset.selectedTiles.every(\n      tile => tile.layers && tile.layers.every(layer => layer.isLoaded)\n    );\n  }\n\n  shouldUpdateState({changeFlags}) {\n    return changeFlags.somethingChanged;\n  }\n\n  updateState({props, oldProps, context, changeFlags}) {\n    let {tileset} = this.state;\n    const createTileCache =\n      !tileset ||\n      changeFlags.dataChanged ||\n      (changeFlags.updateTriggersChanged &&\n        (changeFlags.updateTriggersChanged.all || changeFlags.updateTriggersChanged.getTileData));\n\n    if (createTileCache) {\n      const {\n        maxZoom,\n        minZoom,\n        tileSize,\n        maxCacheSize,\n        maxCacheByteSize,\n        refinementStrategy\n      } = props;\n      tileset = new Tileset2D({\n        getTileData: this.getTileData.bind(this),\n        maxCacheSize,\n        maxCacheByteSize,\n        maxZoom,\n        minZoom,\n        tileSize,\n        refinementStrategy,\n        onTileLoad: this._onTileLoad.bind(this),\n        onTileError: this._onTileError.bind(this)\n      });\n      this.setState({tileset});\n    } else if (changeFlags.propsChanged) {\n      tileset.setOptions(props);\n      // if any props changed, delete the cached layers\n      this.state.tileset.tiles.forEach(tile => {\n        tile.layers = null;\n      });\n    }\n\n    if (createTileCache || changeFlags.viewportChanged) {\n      this._updateTileset();\n    }\n  }\n\n  _updateTileset() {\n    const {tileset} = this.state;\n    const {onViewportLoad} = this.props;\n    const frameNumber = tileset.update(this.context.viewport);\n    const {isLoaded} = tileset;\n\n    const loadingStateChanged = this.state.isLoaded !== isLoaded;\n    const tilesetChanged = this.state.frameNumber !== frameNumber;\n\n    if (isLoaded && onViewportLoad && (loadingStateChanged || tilesetChanged)) {\n      onViewportLoad(tileset.selectedTiles.map(tile => tile.data));\n    }\n\n    if (tilesetChanged) {\n      // Save the tileset frame number - trigger a rerender\n      this.setState({frameNumber});\n    }\n    // Save the loaded state - should not trigger a rerender\n    this.state.isLoaded = isLoaded;\n  }\n\n  _onTileLoad(tile) {\n    const layer = this.getCurrentLayer();\n    layer.props.onTileLoad(tile);\n    layer._updateTileset();\n  }\n\n  _onTileError(error) {\n    const layer = this.getCurrentLayer();\n    layer.props.onTileError(error);\n    // errorred tiles should not block rendering, are considered \"loaded\" with empty data\n    layer._updateTileset();\n  }\n\n  // Methods for subclass to override\n\n  getTileData(tile) {\n    const {getTileData, fetch, data} = this.props;\n\n    tile.url = getURLFromTemplate(data, tile);\n\n    if (getTileData) {\n      return getTileData(tile);\n    }\n    if (tile.url) {\n      return fetch(tile.url, {layer: this});\n    }\n    return null;\n  }\n\n  renderSubLayers(props) {\n    return this.props.renderSubLayers(props);\n  }\n\n  getPickingInfo({info, sourceLayer}) {\n    info.sourceLayer = sourceLayer;\n    info.tile = sourceLayer.props.tile;\n    return info;\n  }\n\n  renderLayers() {\n    const {visible} = this.props;\n    return this.state.tileset.tiles.map(tile => {\n      // For a tile to be visible:\n      // - parent layer must be visible\n      // - tile must be visible in the current viewport\n      const isVisible = visible && tile.isVisible;\n      // cache the rendered layer in the tile\n      if (!tile.layers) {\n        const layers = this.renderSubLayers(\n          Object.assign({}, this.props, {\n            id: `${this.id}-${tile.x}-${tile.y}-${tile.z}`,\n            data: tile.data,\n            visible: isVisible,\n            _offset: 0,\n            tile\n          })\n        );\n        tile.layers = flatten(layers, Boolean);\n      } else if (tile.layers[0] && tile.layers[0].props.visible !== isVisible) {\n        tile.layers = tile.layers.map(layer => layer.clone({visible: isVisible}));\n      }\n      return tile.layers;\n    });\n  }\n}\n\nTileLayer.layerName = 'TileLayer';\nTileLayer.defaultProps = defaultProps;\n"],"file":"tile-layer.js"}