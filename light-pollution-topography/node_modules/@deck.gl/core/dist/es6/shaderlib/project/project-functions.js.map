{"version":3,"sources":["../../../../src/shaderlib/project/project-functions.js"],"names":["COORDINATE_SYSTEM","getOffsetOrigin","vec4","vec3","addMetersToLngLat","lngLatZToWorldPosition","lngLatZ","viewport","offsetMode","longitude","latitude","z","X","Y","projectFlat","distanceScales","getDistanceScales","Z","unitsPerMeter","normalizeParameters","opts","normalizedParams","Object","assign","coordinateSystem","coordinateOrigin","fromCoordinateSystem","fromCoordinateOrigin","DEFAULT","isGeospatial","LNGLAT","CARTESIAN","undefined","getWorldPosition","position","modelMatrix","x","y","transformMat4","LNGLAT_OFFSETS","METER_OFFSETS","projectPosition","params","geospatialOrigin","shaderCoordinateOrigin","worldPosition","positionCommonSpace","sub"],"mappings":"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","sourcesContent":["/**\n * Projection utils\n * TODO: move to Viewport class?\n */\nimport {COORDINATE_SYSTEM} from '../../lib/constants';\nimport {getOffsetOrigin} from './viewport-uniforms';\n\nimport * as vec4 from 'gl-matrix/vec4';\nimport * as vec3 from 'gl-matrix/vec3';\nimport {addMetersToLngLat} from '@math.gl/web-mercator';\n\n// In project.glsl, offset modes calculate z differently from LNG_LAT mode.\n// offset modes apply the y adjustment (unitsPerMeter2) when projecting z\n// LNG_LAT mode only use the linear scale.\nfunction lngLatZToWorldPosition(lngLatZ, viewport, offsetMode = false) {\n  const [longitude, latitude, z = 0] = lngLatZ;\n  const [X, Y] = viewport.projectFlat(lngLatZ);\n  const distanceScales = viewport.getDistanceScales(offsetMode && [longitude, latitude]);\n  const Z = z * distanceScales.unitsPerMeter[2];\n  return [X, Y, Z];\n}\n\nfunction normalizeParameters(opts) {\n  const normalizedParams = Object.assign({}, opts);\n\n  let {coordinateSystem} = opts;\n  const {viewport, coordinateOrigin, fromCoordinateSystem, fromCoordinateOrigin} = opts;\n\n  if (coordinateSystem === COORDINATE_SYSTEM.DEFAULT) {\n    coordinateSystem = viewport.isGeospatial\n      ? COORDINATE_SYSTEM.LNGLAT\n      : COORDINATE_SYSTEM.CARTESIAN;\n  }\n\n  if (fromCoordinateSystem === undefined) {\n    normalizedParams.fromCoordinateSystem = coordinateSystem;\n  }\n  if (fromCoordinateOrigin === undefined) {\n    normalizedParams.fromCoordinateOrigin = coordinateOrigin;\n  }\n\n  normalizedParams.coordinateSystem = coordinateSystem;\n\n  return normalizedParams;\n}\n\nexport function getWorldPosition(\n  position,\n  {viewport, modelMatrix, coordinateSystem, coordinateOrigin, offsetMode}\n) {\n  let [x, y, z] = position;\n\n  if (modelMatrix) {\n    [x, y, z] = vec4.transformMat4([], [x, y, z, 1.0], modelMatrix);\n  }\n\n  switch (coordinateSystem) {\n    case COORDINATE_SYSTEM.LNGLAT:\n      return lngLatZToWorldPosition([x, y, z], viewport, offsetMode);\n\n    case COORDINATE_SYSTEM.LNGLAT_OFFSETS:\n      return lngLatZToWorldPosition(\n        [x + coordinateOrigin[0], y + coordinateOrigin[1], z + (coordinateOrigin[2] || 0)],\n        viewport,\n        offsetMode\n      );\n\n    case COORDINATE_SYSTEM.METER_OFFSETS:\n      return lngLatZToWorldPosition(\n        addMetersToLngLat(coordinateOrigin, [x, y, z]),\n        viewport,\n        offsetMode\n      );\n\n    case COORDINATE_SYSTEM.CARTESIAN:\n    default:\n      return viewport.isGeospatial ? [x, y, z] : viewport.projectPosition([x, y, z]);\n  }\n}\n\n/**\n * Equivalent to project_position in project.glsl\n * projects a user supplied position to world position directly with or without\n * a reference coordinate system\n * @param {array} position - [x, y, z]\n * @param {object} params\n * @param {Viewport} params.viewport - the current viewport\n * @param {number} params.coordinateSystem - the reference coordinate system used\n *   align world position\n * @param {array} params.coordinateOrigin - the reference coordinate origin used\n *   to align world position\n * @param {Matrix4} [params.modelMatrix] - the model matrix of the supplied position\n * @param {number} [params.fromCoordinateSystem] - the coordinate system that the\n *   supplied position is in. Default to the same as `coordinateSystem`.\n * @param {array} [params.fromCoordinateOrigin] - the coordinate origin that the\n *   supplied position is in. Default to the same as `coordinateOrigin`.\n */\nexport function projectPosition(position, params) {\n  const {\n    viewport,\n    coordinateSystem,\n    coordinateOrigin,\n    // optional\n    modelMatrix,\n    fromCoordinateSystem,\n    fromCoordinateOrigin\n  } = normalizeParameters(params);\n\n  const {geospatialOrigin, shaderCoordinateOrigin, offsetMode} = getOffsetOrigin(\n    viewport,\n    coordinateSystem,\n    coordinateOrigin\n  );\n\n  const worldPosition = getWorldPosition(position, {\n    viewport,\n    modelMatrix,\n    coordinateSystem: fromCoordinateSystem,\n    coordinateOrigin: fromCoordinateOrigin,\n    offsetMode\n  });\n\n  if (offsetMode) {\n    const positionCommonSpace = viewport.projectPosition(\n      geospatialOrigin || shaderCoordinateOrigin\n    );\n    vec3.sub(worldPosition, worldPosition, positionCommonSpace);\n  }\n\n  return worldPosition;\n}\n"],"file":"project-functions.js"}